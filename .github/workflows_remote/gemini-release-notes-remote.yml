name: "üìù Gemini Release Notes (Remote)"

on:
  push:
    tags:
      - "*"

permissions:
  contents: write

defaults:
  run:
    shell: bash

env:
  # Áí∞Â¢ÉÂ§âÊï∞„ÅßÂà∂Âæ°ÂèØËÉΩ„Å™Ë®≠ÂÆö
  MAX_COMMITS: 300
  MAX_FILES: 500
  MAX_CONTRIBUTORS: 200
  MAX_DIFF_LINES: 2000  # Êñ∞Ë¶èËøΩÂä†: Â∑ÆÂàÜ„ÅÆÊúÄÂ§ßË°åÊï∞
  MAX_DIFF_CHARS: 200000  # Â∑ÆÂàÜ„ÅÆÊúÄÂ§ßÊñáÂ≠óÊï∞Ôºà„Éê„Ç§„ÉàÊï∞Áõ∏ÂΩìÔºâ
  REMOTE_REPO: 'Sunwood-ai-labsII/gemini-actions-lab'
  REMOTE_BRANCH: 'main'

jobs:
  release-notes:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout default branch
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # ratchet:actions/checkout@v4
        with:
          ref: ${{ github.event.repository.default_branch }}
          fetch-depth: 0

      # „É™„É¢„Éº„Éà„Åã„Çâ„Çπ„ÇØ„É™„Éó„Éà„ÇíÂèñÂæóüöÄ
      - name: Download remote script
        run: |
          set -euo pipefail
          mkdir -p /tmp/remote-scripts
          SCRIPT_URL="https://raw.githubusercontent.com/${REMOTE_REPO}/${REMOTE_BRANCH}/.github/scripts/clamp_diff.py"
          curl -fsSL "${SCRIPT_URL}" -o /tmp/remote-scripts/clamp_diff.py
          chmod +x /tmp/remote-scripts/clamp_diff.py
          echo "‚ú® „Çπ„ÇØ„É™„Éó„Éà„Çí„É™„É¢„Éº„Éà„Åã„ÇâÂèñÂæó„Åó„Åü„Çà„ÄúÔºÅ"

      - name: Prepare context
        id: ctx
        env:
          REPOSITORY: "${{ github.repository }}"
          TAG_NAME: "${{ github.ref_name }}"
          GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
          MAX_COMMITS: "${{ env.MAX_COMMITS }}"
          MAX_FILES: "${{ env.MAX_FILES }}"
          MAX_CONTRIBUTORS: "${{ env.MAX_CONTRIBUTORS }}"
          MAX_DIFF_LINES: "${{ env.MAX_DIFF_LINES }}"
          MAX_DIFF_CHARS: "${{ env.MAX_DIFF_CHARS }}"
        run: |
          set -euo pipefail
          TAG="${TAG_NAME}"
          git fetch --tags --prune --force >/dev/null 2>&1 || true
          # Try to get previous released tag (from Releases). Fallback to previous git tag reachable from current.
          PREV_RELEASE_TAG="$(gh release list --limit 100 --json tagName --jq 'map(.tagName) | map(select(. != env.TAG)) | .[0]' || true)"
          if [[ -z "${PREV_RELEASE_TAG}" || "${PREV_RELEASE_TAG}" == "null" ]]; then
            PREV_RELEASE_TAG="$(git describe --tags --abbrev=0 "${TAG}^" 2>/dev/null || true)"
          fi
          BASE_RANGE=""
          COMPARE_URL=""
          if [[ -n "${PREV_RELEASE_TAG}" ]]; then
            BASE_RANGE="${PREV_RELEASE_TAG}..${TAG}"
            COMPARE_URL="https://github.com/${REPOSITORY}/compare/${PREV_RELEASE_TAG}...${TAG}"
          else
            # Initial release: include history up to the tag commit
            BASE_RANGE="${TAG}"
          fi
          # Collect data (trim to keep prompt concise)
          COMMITS="$(git log --no-merges --pretty=format:'- %s (%h) by %an' ${BASE_RANGE} | head -n ${MAX_COMMITS} || true)"
          CHANGED_FILES="$( ( [[ -n "${PREV_RELEASE_TAG}" ]] && git diff --name-only ${BASE_RANGE} || git ls-tree -r --name-only HEAD ) | sed 's/^/- /' | head -n ${MAX_FILES} || true)"
          CONTRIBUTORS="$(git log --format='%an' ${BASE_RANGE} | sort -u | sed 's/^/- /' | head -n ${MAX_CONTRIBUTORS} || true)"
          
          # üî• Êñ∞Ë¶èËøΩÂä†: ÂÆüÈöõ„ÅÆ„Ç≥„Éº„ÉâÂ∑ÆÂàÜ„ÇíÂèñÂæó
          echo "Collecting code diff (max ${MAX_DIFF_LINES} lines)..."
          DIFF_EXCLUDES=(
            ':!*.png' ':!*.jpg' ':!*.jpeg' ':!*.gif' ':!*.webp' ':!*.avif'
            ':!*.svg' ':!*.svgz' ':!*.pdf' ':!*.drawio' ':!*.dio'
            ':!*.mp4' ':!*.mov' ':!*.zip' ':!*.gz' ':!*.bz2' ':!*.xz'
          )
          # „É™„É¢„Éº„Éà„Çπ„ÇØ„É™„Éó„Éà„Çí‰ΩøÁî®üí™
          clamp_diff() {
            local max_lines="$1"
            local max_chars="$2"
            python3 /tmp/remote-scripts/clamp_diff.py "$max_lines" "$max_chars"
          }

          if [[ -n "${PREV_RELEASE_TAG}" ]]; then
            # Ââç„ÅÆ„É™„É™„Éº„Çπ„Å®„ÅÆÂ∑ÆÂàÜ
            DIFF_CMD=(git diff --no-color "${BASE_RANGE}")
            DIFF_STATS_CMD=(git diff --stat --no-color "${BASE_RANGE}")
            if ((${#DIFF_EXCLUDES[@]} > 0)); then
              DIFF_CMD+=(-- "${DIFF_EXCLUDES[@]}")
              DIFF_STATS_CMD+=(-- "${DIFF_EXCLUDES[@]}")
            fi
            DIFF_CONTENT="$("${DIFF_CMD[@]}" | clamp_diff "${MAX_DIFF_LINES}" "${MAX_DIFF_CHARS}" || true)"
            DIFF_STATS="$("${DIFF_STATS_CMD[@]}" | head -n 100 || true)"
          else
            # ÂàùÂõû„É™„É™„Éº„Çπ: ÂÖ®„Éï„Ç°„Ç§„É´ÂÜÖÂÆπÔºàÂà∂Èôê‰ªò„ÅçÔºâ
            DIFF_CONTENT="$(git show --format="" --name-status HEAD | clamp_diff "${MAX_DIFF_LINES}" "${MAX_DIFF_CHARS}" || true)"
            DIFF_STATS="$(git ls-tree -r --name-only HEAD | wc -l) files in initial release"
          fi
          {
            echo "tag=${TAG}"
            echo "prev_tag=${PREV_RELEASE_TAG}"
            echo "compare_url=${COMPARE_URL}"
            echo 'commits<<EOF'
            echo "${COMMITS}"
            echo 'EOF'
            echo 'files<<EOF'
            echo "${CHANGED_FILES}"
            echo 'EOF'
            echo 'contributors<<EOF'
            echo "${CONTRIBUTORS}"
            echo 'EOF'
            echo 'diff_stats<<EOF'
            echo "${DIFF_STATS}"
            echo 'EOF'
            echo 'diff_content<<EOF'
            echo "${DIFF_CONTENT}"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"
          echo "‚úÖ Collected context:"
          echo "  - Commits: $(echo "${COMMITS}" | wc -l) entries"
          echo "  - Files: $(echo "${CHANGED_FILES}" | wc -l) entries"
          echo "  - Contributors: $(echo "${CONTRIBUTORS}" | wc -l) entries"
          diff_line_count=$(echo "${DIFF_CONTENT}" | wc -l | awk '{print $1}')
          echo "  - Diff lines: ${diff_line_count} lines (max: ${MAX_DIFF_LINES})"

      - name: Generate Gemini release notes
        id: gemini
        uses: google-github-actions/run-gemini-cli@v0
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          gcp_workload_identity_provider: ${{ vars.GCP_WIF_PROVIDER }}
          gcp_project_id: ${{ vars.GOOGLE_CLOUD_PROJECT }}
          gcp_location: ${{ vars.GOOGLE_CLOUD_LOCATION }}
          gcp_service_account: ${{ vars.SERVICE_ACCOUNT_EMAIL }}
          use_vertex_ai: ${{ vars.GOOGLE_GENAI_USE_VERTEXAI }}
          use_gemini_code_assist: ${{ vars.GOOGLE_GENAI_USE_GCA }}
          settings: |-
            {
              "debug": ${{ fromJSON(env.DEBUG || env.ACTIONS_STEP_DEBUG || false) }},
              "maxSessionTurns": 12,
              "telemetry": {
                "enabled": false,
                "target": "gcp"
              }
            }
          prompt: |-
            „ÅÇ„Å™„Åü„ÅØ„ÄÅGitHub Actions„Å´„Çà„ÇãËá™Âãï„É™„É™„Éº„Çπ„Éé„Éº„ÉàÁîüÊàê„ÇíÊãÖÂΩì„Åô„Çã„Ç¢„Ç∑„Çπ„Çø„É≥„Éà„Åß„Åô„ÄÇ
            ‰ª•‰∏ã„ÅÆ„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„Çí„ÇÇ„Å®„Å´„ÄÅÈ≠ÖÂäõÁöÑ„ÅßÂàÜ„Åã„Çä„ÇÑ„Åô„ÅÑ„É™„É™„Éº„Çπ„Éé„Éº„Éà„ÇíÊó•Êú¨Ë™û„Åß‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

            ## „É™„É™„Éº„ÇπÊÉÖÂ†±
            - **„Çø„Ç∞**: ${{ steps.ctx.outputs.tag }}
            - **ÂâçÂõû„Çø„Ç∞**: ${{ steps.ctx.outputs.prev_tag }}
            ${{ steps.ctx.outputs.compare_url && format('- **Â∑ÆÂàÜÊØîËºÉ**: {0}', steps.ctx.outputs.compare_url) || '' }}

            ## „Ç≥„Éü„ÉÉ„ÉàÂ±•Ê≠¥
            ${{ steps.ctx.outputs.commits }}

            ## Â§âÊõ¥„Éï„Ç°„Ç§„É´
            ${{ steps.ctx.outputs.files }}

            ## „Ç≥„É≥„Éà„É™„Éì„É•„Éº„Çø„Éº
            ${{ steps.ctx.outputs.contributors }}

            ## Â∑ÆÂàÜÁµ±Ë®à
            ${{ steps.ctx.outputs.diff_stats }}

            ## „Ç≥„Éº„ÉâÂ∑ÆÂàÜ (ÊäúÁ≤ã)
            ```diff
            ${{ steps.ctx.outputs.diff_content }}
            ```

            ## ÊåáÁ§∫
            ‰∏äË®ò„ÅÆÊÉÖÂ†±„Çí„ÇÇ„Å®„Å´„ÄÅ‰ª•‰∏ã„ÅÆÂΩ¢Âºè„Åß„É™„É™„Éº„Çπ„Éé„Éº„Éà„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö

            ### „Éï„Ç©„Éº„Éû„ÉÉ„Éà
            ```markdown
            ## üéâ [„Çø„Ç∞Âêç] - [„É™„É™„Éº„ÇπÊó•]

            ### üìã Ê¶ÇË¶Å
            „Åì„ÅÆ„É™„É™„Éº„Çπ„ÅÆ‰∏ª„Å™Â§âÊõ¥ÁÇπ„ÇíÁ∞°ÊΩî„Å´Ë™¨Êòé„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

            ### ‚ú® Êñ∞Ê©üËÉΩ
            - ËøΩÂä†„Åï„Çå„ÅüÊ©üËÉΩ„ÇíÁÆáÊù°Êõ∏„Åç„ÅßÂàóÊåô

            ### üêõ „Éê„Ç∞‰øÆÊ≠£
            - ‰øÆÊ≠£„Åï„Çå„Åü„Éê„Ç∞„ÇíÁÆáÊù°Êõ∏„Åç„ÅßÂàóÊåô

            ### üîß ÊîπÂñÑ
            - „Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÊîπÂñÑ„ÇÑÂÜÖÈÉ®ÁöÑ„Å™Â§âÊõ¥„ÇíÁÆáÊù°Êõ∏„Åç„ÅßÂàóÊåô

            ### üìù „Éâ„Ç≠„É•„É°„É≥„Éà
            - „Éâ„Ç≠„É•„É°„É≥„Éà„ÅÆÊõ¥Êñ∞„ÇíÁÆáÊù°Êõ∏„Åç„ÅßÂàóÊåô

            ### üôè „Ç≥„É≥„Éà„É™„Éì„É•„Éº„Çø„Éº
            „Åì„ÅÆ„É™„É™„Éº„Çπ„Å´Ë≤¢ÁåÆ„Åó„Å¶„Åè„Å†„Åï„Å£„ÅüÊñπ„ÄÖÔºà„Ç≥„Éü„ÉÉ„Éà‰ΩúÊàêËÄÖ„É™„Çπ„Éà„Åã„ÇâÔºâ

            ### üì¶ „Ç§„É≥„Çπ„Éà„Éº„É´
            ```bash
            # „Ç§„É≥„Çπ„Éà„Éº„É´ÊñπÊ≥ï„ÇÑ„Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„ÉâÊñπÊ≥ï„ÇíË®òËºâ
            ```

            ### üîó „É™„É≥„ÇØ
            - [ÂÆåÂÖ®„Å™Â§âÊõ¥Â±•Ê≠¥](${{ steps.ctx.outputs.compare_url }})
            ```

            ## Ê≥®ÊÑè‰∫ãÈ†Ö
            - ÊäÄË°ìÁöÑ„Å™Ë©≥Á¥∞„ÅØÈÅ©Â∫¶„Å´ÊäΩË±°Âåñ„Åó„ÄÅ„É¶„Éº„Ç∂„Éº„Å´„Å®„Å£„Å¶ÂàÜ„Åã„Çä„ÇÑ„Åô„ÅÑË°®Áèæ„ÇíÂøÉ„Åå„Åë„Å¶„Åè„Å†„Åï„ÅÑ
            - Â§âÊõ¥„ÅÆÈáçË¶ÅÂ∫¶„Å´Âøú„Åò„Å¶„Çª„ÇØ„Ç∑„Éß„É≥„ÇíË™øÊï¥„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàË©≤ÂΩìÈ†ÖÁõÆ„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÁúÅÁï•ÂèØÔºâ
            - „Ç≥„Éº„ÉâÂ∑ÆÂàÜ„Åã„ÇâÂÆüË≥™ÁöÑ„Å™Â§âÊõ¥ÂÜÖÂÆπ„ÇíË™≠„ÅøÂèñ„Çä„ÄÅÈÅ©Âàá„Å™„Ç´„ÉÜ„Ç¥„É™„Å´ÂàÜÈ°û„Åó„Å¶„Åè„Å†„Åï„ÅÑ
            - „Ç≥„Éü„ÉÉ„Éà„É°„ÉÉ„Çª„Éº„Ç∏„Åã„ÇâÊÑèÂõ≥„ÇíÊé®Ê∏¨„Åó„ÄÅ„É¶„Éº„Ç∂„ÉºË¶ñÁÇπ„Åß„ÅÆ„É°„É™„ÉÉ„Éà„ÇíË®òËø∞„Åó„Å¶„Åè„Å†„Åï„ÅÑ

      - name: Publish release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.ctx.outputs.tag }}
          RELEASE_NOTES: ${{ steps.gemini.outputs.summary != '' && steps.gemini.outputs.summary || steps.gemini.outputs.text }}
        run: |
          set -euo pipefail
          echo "${RELEASE_NOTES}" > release-notes.md
          gh release create "${TAG}" \
            --title "Release ${TAG}" \
            --notes-file release-notes.md \
            --verify-tag || {
              echo "Failed to create release. It may already exist."
              gh release edit "${TAG}" --notes-file release-notes.md || true
            }
          echo "‚úÖ Release published: ${TAG}"
