name: "ğŸ“° Gemini Release Article"

on:
  workflow_run:
    workflows:
      - "ğŸ“ Gemini Release Notes"
    types:
      - completed

permissions:
  contents: write

defaults:
  run:
    shell: bash

env:
  MAX_COMMITS: 300
  MAX_FILES: 500
  MAX_CONTRIBUTORS: 200
  MAX_DIFF_LINES: 2000
  OASIS_ARTICLE_REPOSITORY: ${{ vars.OASIS_ARTICLE_REPOSITORY || 'Sunwood-ai-labs/oasis-sync' }}
  OASIS_ARTICLE_REPOSITORY_REF: ${{ vars.OASIS_ARTICLE_REPOSITORY_REF || github.event.repository.default_branch }}

jobs:
  oasis-article:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout default branch
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # ratchet:actions/checkout@v4
        with:
          ref: ${{ github.event.repository.default_branch }}
          fetch-depth: 0
          token: ${{ secrets.GH_PAT }}

      - name: Determine release tag
        id: tag
        env:
          TRIGGER_SHA: "${{ github.event.workflow_run.head_sha }}"
          HEAD_BRANCH: "${{ github.event.workflow_run.head_branch }}"
        run: |
          set -euo pipefail
          git fetch --tags --force --prune >/dev/null 2>&1 || true
          TAGS_FOR_SHA="$(git tag --points-at "${TRIGGER_SHA}" || true)"
          TAG="$(echo "${TAGS_FOR_SHA}" | head -n 1 || true)"
          if [[ -z "${TAG}" && -n "${HEAD_BRANCH}" ]]; then
            TAG="${HEAD_BRANCH}"
          fi
          if [[ -z "${TAG}" ]]; then
            echo "Could not determine tag for trigger SHA ${TRIGGER_SHA}" >&2
            exit 1
          fi
          {
            echo "tag=${TAG}"
            echo "sha=${TRIGGER_SHA}"
          } >> "$GITHUB_OUTPUT"

      - name: Prepare context
        id: ctx
        env:
          REPOSITORY: "${{ github.repository }}"
          TAG_NAME: "${{ steps.tag.outputs.tag }}"
          GITHUB_TOKEN: "${{ secrets.GH_PAT }}"
          MAX_COMMITS: "${{ env.MAX_COMMITS }}"
          MAX_FILES: "${{ env.MAX_FILES }}"
          MAX_CONTRIBUTORS: "${{ env.MAX_CONTRIBUTORS }}"
          MAX_DIFF_LINES: "${{ env.MAX_DIFF_LINES }}"
        run: |
          set -euo pipefail
          TAG="${TAG_NAME}"
          git fetch --tags --prune --force >/dev/null 2>&1 || true
          PREV_RELEASE_TAG="$(gh release list --limit 100 --json tagName --jq 'map(.tagName) | map(select(. != env.TAG)) | .[0]' || true)"
          if [[ -z "${PREV_RELEASE_TAG}" || "${PREV_RELEASE_TAG}" == "null" ]]; then
            PREV_RELEASE_TAG="$(git describe --tags --abbrev=0 "${TAG}^" 2>/dev/null || true)"
          fi
          BASE_RANGE=""
          COMPARE_URL=""
          if [[ -n "${PREV_RELEASE_TAG}" ]]; then
            BASE_RANGE="${PREV_RELEASE_TAG}..${TAG}"
            COMPARE_URL="https://github.com/${REPOSITORY}/compare/${PREV_RELEASE_TAG}...${TAG}"
          else
            BASE_RANGE="${TAG}"
          fi
          COMMITS="$(git log --no-merges --pretty=format:'- %s (%h) by %an' ${BASE_RANGE} | head -n ${MAX_COMMITS} || true)"
          CHANGED_FILES="$( ( [[ -n "${PREV_RELEASE_TAG}" ]] && git diff --name-only ${BASE_RANGE} || git ls-tree -r --name-only HEAD ) | sed 's/^/- /' | head -n ${MAX_FILES} || true)"
          CONTRIBUTORS="$(git log --format='%an' ${BASE_RANGE} | sort -u | sed 's/^/- /' | head -n ${MAX_CONTRIBUTORS} || true)"
          echo "Collecting code diff (max ${MAX_DIFF_LINES} lines)..."
          if [[ -n "${PREV_RELEASE_TAG}" ]]; then
            DIFF_CONTENT="$(git diff ${BASE_RANGE} | head -n ${MAX_DIFF_LINES} || true)"
            DIFF_STATS="$(git diff --stat ${BASE_RANGE} | head -n 100 || true)"
          else
            DIFF_CONTENT="$(git show --format="" --name-status HEAD | head -n ${MAX_DIFF_LINES} || true)"
            DIFF_STATS="$(git ls-tree -r --name-only HEAD | wc -l) files in initial release"
          fi
          {
            echo "tag=${TAG}"
            echo "prev_tag=${PREV_RELEASE_TAG}"
            echo "compare_url=${COMPARE_URL}"
            echo 'commits<<EOF'
            echo "${COMMITS}"
            echo 'EOF'
            echo 'files<<EOF'
            echo "${CHANGED_FILES}"
            echo 'EOF'
            echo 'contributors<<EOF'
            echo "${CONTRIBUTORS}"
            echo 'EOF'
            echo 'diff_stats<<EOF'
            echo "${DIFF_STATS}"
            echo 'EOF'
            echo 'diff_content<<EOF'
            echo "${DIFF_CONTENT}"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Fetch release notes body
        id: notes
        env:
          TAG: "${{ steps.ctx.outputs.tag }}"
          GITHUB_TOKEN: "${{ secrets.GH_PAT }}"
        run: |
          set -euo pipefail
          NOTES="$(gh release view "${TAG}" --json body --jq '.body' || true)"
          if [[ -z "${NOTES}" ]]; then
            echo "Release notes for ${TAG} were not found" >&2
            exit 1
          fi
          {
            echo 'summary<<EOF'
            echo "${NOTES}"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Locate header image
        id: header
        env:
          TAG: "${{ steps.ctx.outputs.tag }}"
          REPOSITORY: "${{ github.repository }}"
          DEFAULT_BRANCH: "${{ github.event.repository.default_branch }}"
        run: |
          set -euo pipefail
          base_dir="generated-images"
          if [[ ! -d "${base_dir}" ]]; then
            echo "No generated-images directory detected; skipping header image lookup."
            exit 0
          fi
          dir=$(find "${base_dir}" -maxdepth 1 -type d -name "release-${TAG}-*" | sort | tail -n 1 || true)
          if [[ -z "${dir}" ]]; then
            echo "No header directory found for tag ${TAG}"
            exit 0
          fi
          image=$(find "${dir}" -maxdepth 1 -type f \( -iname '*.png' -o -iname '*.jpg' -o -iname '*.jpeg' \) | sort | head -n 1 || true)
          if [[ -z "${image}" ]]; then
            echo "No header image file found in ${dir}"
            exit 0
          fi
          image_name="$(basename "${image}")"
          raw_url="https://raw.githubusercontent.com/${REPOSITORY}/${DEFAULT_BRANCH}/${image}"
          {
            echo "image_path=${image}"
            echo "image_name=${image_name}"
            echo "raw_url=${raw_url}"
          } >> "$GITHUB_OUTPUT"
          echo "Found header image: ${image}"
          echo "RAW URL: ${raw_url}"

      - name: Load sample article
        id: sample_article
        run: |
          set -euo pipefail
          SAMPLE_PATH=".github/prompts/git-it-write-guide-20251012.md"
          if [[ ! -f "${SAMPLE_PATH}" ]]; then
            echo "sample_path=${SAMPLE_PATH}" >> "$GITHUB_OUTPUT"
            echo "content=" >> "$GITHUB_OUTPUT"
            echo "Sample article file ${SAMPLE_PATH} was not found." >&2
            exit 0
          fi
          {
            echo "sample_path=${SAMPLE_PATH}"
            echo 'content<<EOF'
            cat "${SAMPLE_PATH}"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Generate Oasis article with Gemini
        id: oasis_article
        uses: google-github-actions/run-gemini-cli@v0
        env:
          REPOSITORY: "${{ github.repository }}"
          TAG_NAME: "${{ steps.ctx.outputs.tag }}"
          PREV_TAG: "${{ steps.ctx.outputs.prev_tag }}"
          COMPARE_URL: "${{ steps.ctx.outputs.compare_url }}"
          COMMITS: "${{ steps.ctx.outputs.commits }}"
          CHANGED_FILES: "${{ steps.ctx.outputs.files }}"
          CONTRIBUTORS: "${{ steps.ctx.outputs.contributors }}"
          DIFF_STATS: "${{ steps.ctx.outputs.diff_stats }}"
          DIFF_CONTENT: "${{ steps.ctx.outputs.diff_content }}"
          RELEASE_NOTES: "${{ steps.notes.outputs.summary }}"
          HEADER_IMAGE_URL: "${{ steps.header.outputs.raw_url }}"
          HEADER_IMAGE_NAME: "${{ steps.header.outputs.image_name }}"
        with:
          gemini_api_key: "${{ secrets.GEMINI_API_KEY }}"
          gcp_workload_identity_provider: "${{ vars.GCP_WIF_PROVIDER }}"
          gcp_project_id: "${{ vars.GOOGLE_CLOUD_PROJECT }}"
          gcp_location: "${{ vars.GOOGLE_CLOUD_LOCATION }}"
          gcp_service_account: "${{ vars.SERVICE_ACCOUNT_EMAIL }}"
          use_vertex_ai: "${{ vars.GOOGLE_GENAI_USE_VERTEXAI }}"
          use_gemini_code_assist: "${{ vars.GOOGLE_GENAI_USE_GCA }}"
          settings: |
            { "debug": false, "maxSessionTurns": 10, "telemetry": { "enabled": false, "target": "gcp" } }
          prompt: |
            ã‚ãªãŸã¯Oasisãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®æŠ€è¡“è¨˜äº‹ä½œæˆã®ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã§ã™ã€‚ä»¥ä¸‹ã®æƒ…å ±ã‚’åŸºã«ã€GitHubãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’é¡Œæã¨ã—ãŸæŠ€è¡“è¨˜äº‹ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
            
            # ç›®çš„
            - GitHubãƒªãƒªãƒ¼ã‚¹ã®æŠ€è¡“çš„ãªèƒŒæ™¯ã‚’ã‚ã‹ã‚Šã‚„ã™ãã¾ã¨ã‚ãŸãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆè¨˜äº‹ã‚’ä½œæˆã™ã‚‹
            - Oasisãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆzenn/qiita/wordpress front matter + æœ¬æ–‡ï¼‰ã§å‡ºåŠ›ã™ã‚‹
            - å‚è€ƒãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: articles/oasis/git-it-write-guide-20251012-V5.md
            - ä»¥ä¸‹ã®ã‚µãƒ³ãƒ—ãƒ«è¨˜äº‹æ§‹æˆã‚’å‚è€ƒã«ã™ã‚‹
            
            # ãƒ•ãƒ­ãƒ³ãƒˆãƒã‚¿ãƒ¼è¦ä»¶
            - å…ˆé ­ã‚’ `---` ã§é–‹å§‹ã—ã€æœ€å¾Œã‚‚ `---` ã§é–‰ã˜ã‚‹
            - `zenn`, `qiita`, `wordpress` ã®é †ã§ãƒã‚¹ãƒˆã—ãŸã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½œã‚‹
            - `zenn`:
              - `title`: "ã€ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã€‘{æ¨æ¸¬ã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå} ${{ steps.ctx.outputs.tag }} - {ä¸»è¦ãªå¤‰æ›´ç‚¹ã‚’çŸ­ãè¦ç´„}"
              - `emoji`: è¨˜äº‹å†…å®¹ã«åˆã†1æ–‡å­—
              - `type`: `tech`
              - `topics`: 4ã€œ5ä»¶ã®é–¢é€£æŠ€è¡“ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆè‹±å°æ–‡å­—ã€ãƒã‚¤ãƒ•ãƒ³åŒºåˆ‡ã‚Šå¯ï¼‰
              - `published`: true
            - `qiita`:
              - `title`: Zennã‚¿ã‚¤ãƒˆãƒ«ã¨åŒã˜
              - `tags`: 5ä»¶ï¼ˆå…ˆé ­å¤§æ–‡å­—æ¨å¥¨ã€æŠ€è¡“çš„ã«é–¢é€£ã™ã‚‹å˜èªï¼‰
              - `private`: false
              - `updated_at`: null
              - `id`: null
              - `organization_url_name`: null
              - `slide`: false
              - `ignorePublish`: false
            - `wordpress`:
              - `title`: åŒã˜ã‚¿ã‚¤ãƒˆãƒ«
              - `post_status`: `publish`
              - `post_excerpt`: 2ã€œ3æ–‡ã§è¦ç´„
              - `featured_image`: ãƒ˜ãƒƒãƒ€ãƒ¼ç”»åƒãŒå­˜åœ¨ã™ã‚Œã° `${{ steps.header.outputs.raw_url }}`ã€ç„¡ã‘ã‚Œã°ç©ºæ–‡å­— `""`
              - `taxonomy.category`: 2ã€œ3ä»¶ã®ã‚«ãƒ†ã‚´ãƒªã‚­ãƒ¼
              - `taxonomy.post_tag`: 5ä»¶ã®ã‚¿ã‚°
              - `custom_fields.lead`: è¨˜äº‹å†’é ­ã§ä½¿ã†ãƒªãƒ¼ãƒ‰æ–‡ï¼ˆ2ã€œ3æ–‡ï¼‰
            - é…åˆ—ã¯ YAML ã®ãƒªã‚¹ãƒˆæ§‹æ–‡ï¼ˆ`- value`ï¼‰ã‚’ä½¿ã„ã€ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã¯2ã‚¹ãƒšãƒ¼ã‚¹ã§çµ±ä¸€ã™ã‚‹
            - æœªè¨­å®šã®æ–‡å­—åˆ—ã¯ç©ºæ–‡å­— `""` ã‚’ä½¿ç”¨ã—ã€null é …ç›®ã¯ `null` ã‚’æ˜è¨˜ã™ã‚‹
            - front matter ã¨æœ¬æ–‡ã®é–“ã«ã¯ç©ºè¡Œã‚’1è¡Œå…¥ã‚Œã‚‹
            
            # æœ¬æ–‡è¦ä»¶
            - ã‚»ã‚¯ã‚·ãƒ§ãƒ³æ§‹æˆã¯ä»¥ä¸‹ã‚’åŸºæœ¬ã¨ã—ã€å¿…è¦ã«å¿œã˜ã¦è£œè¶³è¦‹å‡ºã—ã‚’è¿½åŠ ã™ã‚‹
              - `## ã¯ã˜ã‚ã«`
              - `## ä¸»ãªå¤‰æ›´ç‚¹`
              - `## æŠ€è¡“çš„ãªè©³ç´°`
              - `### æ–°æ©Ÿèƒ½`
              - `### æ”¹å–„ç‚¹`
              - `### ãƒã‚°ä¿®æ­£`
              - `## ã¾ã¨ã‚`
              - `---`
              - `ğŸ“š å‚è€ƒãƒªãƒ³ã‚¯`
            - `HEADER_IMAGE_URL` ãŒã‚ã‚Œã° front matter ã®ç›´å¾Œã« `![<image_name>](<image_url>)` å½¢å¼ã§ç”»åƒã‚’æŒ¿å…¥ã™ã‚‹
            - å¤‰æ›´ç‚¹ã¯ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆãƒ»ã‚³ãƒŸãƒƒãƒˆãƒ»å·®åˆ†ã‚’å¼•ç”¨ã—ãªãŒã‚‰ã€é–‹ç™ºè€…ãŒç†è§£ã—ã‚„ã™ã„è¨€è‘‰ã§è§£èª¬ã™ã‚‹
            - å¿…è¦ã«å¿œã˜ã¦ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚„è¡¨ã€ç®‡æ¡æ›¸ãã‚’ä½¿ã£ã¦æ•´ç†ã™ã‚‹
            - æ–‡ç« ã¯æ—¥æœ¬èªã§ä½œæˆã—ã€å…·ä½“çš„ãªãƒ¡ãƒªãƒƒãƒˆã€ç§»è¡Œæ‰‹é †ã€æ³¨æ„ç‚¹ã‚’å«ã‚ã‚‹
            - æœ¬æ–‡å†’é ­ã§ã‚¿ã‚¤ãƒˆãƒ«ã‚’å†æ²ã›ãšã€front matter ã®ã‚¿ã‚¤ãƒˆãƒ«ã¨é‡è¤‡ã•ã›ãªã„
            - æœ¬æ–‡å…¨ä½“ã¯é€šå¸¸ã®Markdownã¨ã—ã¦å‡ºåŠ›ã—ã€ä¸‰é€£ãƒãƒƒã‚¯ã‚¯ã‚©ãƒ¼ãƒˆãªã©ã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã§å…¨ä½“ã‚’å›²ã¾ãªã„
            - å„è¦‹å‡ºã—ã¯ä¸€åº¦ã ã‘ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³è¨˜æ³•ã‚’ä»˜ã‘ã€`##` ã‚„ `###` ãŒé‡è¤‡ã—ãªã„ã‚ˆã†ã«ã™ã‚‹
            - è¦‹å‡ºã—ã‚„ç¯€ã‚¿ã‚¤ãƒˆãƒ«ã«ç•ªå·ã‚’ä»˜ã‘ãšã€ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ†ã‚­ã‚¹ãƒˆã®ã¿ã§è¡¨ç¾ã™ã‚‹
            - `ğŸ“š å‚è€ƒãƒªãƒ³ã‚¯` ã«ã¯ GitHub ãƒªãƒã‚¸ãƒˆãƒªã€æ¯”è¼ƒURLã€ãƒªãƒªãƒ¼ã‚¹ãƒšãƒ¼ã‚¸ã‚’å«ã‚ã‚‹
            - ç®‡æ¡æ›¸ãã‚„è¡¨ã®ã‚¹ã‚¿ã‚¤ãƒ«ã€ãƒªãƒ¼ãƒ‰æ–‡ã®ãƒˆãƒ¼ãƒ³ã¯ä¸‹è¨˜ã‚µãƒ³ãƒ—ãƒ«ã¨æ•´åˆã•ã›ã‚‹
            
            # ã‚µãƒ³ãƒ—ãƒ«è¨˜äº‹ (å‚è€ƒç”¨ã€å‡ºåŠ›ã«ã¯å«ã‚ãªã„)
            ```markdown
            ${{ steps.sample_article.outputs.content }}
            ```

            # æä¾›ãƒ‡ãƒ¼ã‚¿
            - ãƒªãƒã‚¸ãƒˆãƒª: ${{ github.repository }}
            - ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚°: ${{ steps.ctx.outputs.tag }}
            - å‰ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚°: ${{ steps.ctx.outputs.prev_tag }}
            - æ¯”è¼ƒURL: ${{ steps.ctx.outputs.compare_url }}
            - ãƒ˜ãƒƒãƒ€ãƒ¼ç”»åƒURL: ${{ steps.header.outputs.raw_url }}
            - ãƒ˜ãƒƒãƒ€ãƒ¼ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«å: ${{ steps.header.outputs.image_name }}
            - ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆæœ¬æ–‡:
              ${{ steps.notes.outputs.summary }}
            - å·®åˆ†çµ±è¨ˆ:
              ${{ steps.ctx.outputs.diff_stats }}
            - å·®åˆ†å†…å®¹:
              ```diff
              ${{ steps.ctx.outputs.diff_content }}
              ```
            - ã‚³ãƒŸãƒƒãƒˆä¸€è¦§:
              ${{ steps.ctx.outputs.commits }}
            - å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§:
              ${{ steps.ctx.outputs.files }}
            - ä¸»è¦è²¢çŒ®è€…:
              ${{ steps.ctx.outputs.contributors }}
            
            # å‡ºåŠ›å½¢å¼
            - Oasisãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«æº–æ‹ ã—ãŸ1ã¤ã®Markdownãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã¿ã‚’å‡ºåŠ›ã™ã‚‹
            - ç”Ÿæˆçµæœã¯ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã§å›²ã¾ãšã€front matter ã¨æœ¬æ–‡ã ã‘ã‚’å«ã‚ã‚‹
            - èª¬æ˜æ–‡ã‚„ä½™è¨ˆãªã‚³ãƒ¡ãƒ³ãƒˆã¯å«ã‚ãªã„

      - name: Clone target article repository
        id: clone_target
        env:
          TARGET_REPOSITORY: "${{ env.OASIS_ARTICLE_REPOSITORY }}"
          TARGET_REF: "${{ env.OASIS_ARTICLE_REPOSITORY_REF }}"
          GITHUB_TOKEN: "${{ secrets.GH_PAT }}"
        run: |
          set -euo pipefail
          if [[ -z "${TARGET_REPOSITORY}" ]]; then
            echo "OASIS_ARTICLE_REPOSITORY must not be empty." >&2
            exit 1
          fi
          if [[ -z "${GITHUB_TOKEN}" ]]; then
            echo "GITHUB_TOKEN is required to clone the target repository." >&2
            exit 1
          fi
          CLONE_ROOT="$(mktemp -d "${RUNNER_TEMP}/oasis-articles-XXXXXX")"
          CLONE_DIR="${CLONE_ROOT}/repo"
          GIT_URL="https://x-access-token:${GITHUB_TOKEN}@github.com/${TARGET_REPOSITORY}.git"
          git clone --depth 1 "${GIT_URL}" "${CLONE_DIR}"
          pushd "${CLONE_DIR}" >/dev/null
          DEFAULT_BRANCH="$(git rev-parse --abbrev-ref HEAD)"
          if [[ -n "${TARGET_REF}" && "${TARGET_REF}" != "${DEFAULT_BRANCH}" ]]; then
            if git ls-remote --exit-code --heads origin "${TARGET_REF}" >/dev/null 2>&1; then
              git fetch origin "${TARGET_REF}:${TARGET_REF}" --depth 1 >/dev/null 2>&1 || true
              git checkout "${TARGET_REF}" >/dev/null 2>&1
            else
              git checkout -b "${TARGET_REF}" >/dev/null 2>&1
            fi
          fi
          popd >/dev/null
          {
            echo "dir=${CLONE_DIR}"
          } >> "$GITHUB_OUTPUT"

      - name: Create Oasis article file
        id: oasis_file
        env:
          TAG: "${{ steps.ctx.outputs.tag }}"
          REPOSITORY: "${{ github.repository }}"
          OASIS_CONTENT: "${{ steps.oasis_article.outputs.summary }}"
          HEADER_IMAGE_URL: "${{ steps.header.outputs.raw_url }}"
          HEADER_IMAGE_NAME: "${{ steps.header.outputs.image_name }}"
          TARGET_DIR: "${{ steps.clone_target.outputs.dir }}"
        run: |
          set -euo pipefail
          if [[ -z "${TARGET_DIR}" ]]; then
            echo "Target repository directory not provided." >&2
            exit 1
          fi
          REPO_NAME="${REPOSITORY##*/}"
          TAG_CLEAN="${TAG#v}"
          TIMESTAMP=$(date +%Y%m%d)
          RAW_SLUG="${TIMESTAMP}-${REPO_NAME}-${TAG_CLEAN}-release"
          RAW_SLUG="${RAW_SLUG,,}"
          SLUG=$(echo "${RAW_SLUG}" \
            | sed 's/[^a-z0-9_-]/-/g' \
            | sed -E 's/-{2,}/-/g' \
            | sed -E 's/_{2,}/_/g' \
            | sed -E 's/^[-_]+//; s/[-_]+$//')
          if [[ -z "${SLUG}" ]]; then
            SLUG="${TIMESTAMP}-release"
          fi
          if [[ ${#SLUG} -gt 50 ]]; then
            SLUG="${SLUG:0:50}"
            SLUG=$(echo "${SLUG}" | sed -E 's/[-_]+$//')
          fi
          while [[ ${#SLUG} -lt 12 ]]; do
            SLUG="${SLUG}x"
          done
          if [[ ! "${SLUG}" =~ ^[a-z0-9_-]{12,50}$ ]]; then
            echo "ç”Ÿæˆã•ã‚ŒãŸslug '${SLUG}' ãŒåˆ¶ç´„ã‚’æº€ãŸã—ã¾ã›ã‚“" >&2
            exit 1
          fi
          FILENAME="${SLUG}.md"
          FILEPATH="articles/oasis/${FILENAME}"
          mkdir -p "articles/oasis"
          RAW_FILE="$(mktemp)"
          CLEAN_FILE="$(mktemp)"
          trap 'rm -f "${RAW_FILE}" "${CLEAN_FILE}"' EXIT
          printf "%s\n" "${OASIS_CONTENT}" > "${RAW_FILE}"
          FIRST_LINE="$(head -n 1 "${RAW_FILE}")"
          LAST_LINE="$(tail -n 1 "${RAW_FILE}")"
          CONTENT_FILE="${RAW_FILE}"
          if [[ "${FIRST_LINE}" =~ ^\`\`\`(markdown)?$ ]] && [[ "${LAST_LINE}" == '```' ]]; then
            if [[ $(wc -l < "${RAW_FILE}") -ge 2 ]]; then
              sed '1d;$d' "${RAW_FILE}" > "${CLEAN_FILE}"
              CONTENT_FILE="${CLEAN_FILE}"
            fi
          fi
          if [[ -z "$(tr -d '[:space:]' < "${CONTENT_FILE}")" ]]; then
            echo "ç”Ÿæˆã•ã‚ŒãŸè¨˜äº‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒç©ºã§ã™" >&2
            exit 1
          fi
          FILEPATH_REL="articles/oasis/${FILENAME}"
          FILEPATH="${TARGET_DIR}/${FILEPATH_REL}"
          mkdir -p "$(dirname "${FILEPATH}")"
          HAS_CHANGES="true"
          if [[ -f "${FILEPATH}" ]] && diff -q "${CONTENT_FILE}" "${FILEPATH}" >/dev/null; then
            HAS_CHANGES="false"
            echo "No content changes detected for ${FILEPATH_REL}"
          else
            cp "${CONTENT_FILE}" "${FILEPATH}"
            echo "âœ… Oasis article prepared at ${FILEPATH_REL}"
          fi
          rm -f "${RAW_FILE}" "${CLEAN_FILE}"
          trap - EXIT
          echo "oasis_filename=${FILENAME}" >> "$GITHUB_OUTPUT"
          echo "oasis_filepath=${FILEPATH_REL}" >> "$GITHUB_OUTPUT"
          echo "oasis_fullpath=${FILEPATH}" >> "$GITHUB_OUTPUT"
          echo "slug=${SLUG}" >> "$GITHUB_OUTPUT"
          echo "has_changes=${HAS_CHANGES}" >> "$GITHUB_OUTPUT"

      - name: Push Oasis article to target repository
        env:
          TARGET_REPOSITORY: "${{ env.OASIS_ARTICLE_REPOSITORY }}"
          TARGET_REF: "${{ env.OASIS_ARTICLE_REPOSITORY_REF }}"
          TARGET_DIR: "${{ steps.clone_target.outputs.dir }}"
          OASIS_FILEPATH: "${{ steps.oasis_file.outputs.oasis_filepath }}"
          OASIS_FULLPATH: "${{ steps.oasis_file.outputs.oasis_fullpath }}"
          HAS_CHANGES: "${{ steps.oasis_file.outputs.has_changes }}"
          COMMIT_MESSAGE: "ğŸ“° Add Oasis release article for ${{ github.repository }} ${{ steps.ctx.outputs.tag }}"
          GITHUB_TOKEN: "${{ secrets.GH_PAT }}"
        run: |
          set -euo pipefail
          if [[ "${HAS_CHANGES}" != "true" ]]; then
            echo "No content changes to publish."
            exit 0
          fi
          if [[ -z "${TARGET_DIR}" ]]; then
            echo "Target repository directory not provided." >&2
            exit 1
          fi
          if [[ -z "${OASIS_FILEPATH}" || -z "${OASIS_FULLPATH}" ]]; then
            echo "Article file paths not provided." >&2
            exit 1
          fi
          if [[ ! -f "${OASIS_FULLPATH}" ]]; then
            echo "Article file ${OASIS_FULLPATH} was not found." >&2
            exit 1
          fi
          if [[ -z "${TARGET_REPOSITORY}" ]]; then
            echo "OASIS_ARTICLE_REPOSITORY must not be empty." >&2
            exit 1
          fi
          if [[ -z "${GITHUB_TOKEN}" ]]; then
            echo "GITHUB_TOKEN is required to push changes." >&2
            exit 1
          fi
          export GH_TOKEN="${GITHUB_TOKEN}"
          gh auth setup-git >/dev/null
          pushd "${TARGET_DIR}" >/dev/null
          if [[ -n "${TARGET_REF}" ]]; then
            git checkout "${TARGET_REF}" >/dev/null 2>&1 || git checkout -b "${TARGET_REF}"
          fi
          git add "${OASIS_FILEPATH}"
          if git diff --cached --quiet; then
            echo "No staged changes to commit."
            popd >/dev/null
            exit 0
          fi
          AUTHOR_LOGIN="$(gh api user --jq .login 2>/dev/null || echo "")"
          if [[ -z "${AUTHOR_LOGIN}" || "${AUTHOR_LOGIN}" == "null" ]]; then
            AUTHOR_LOGIN="oasis-automation"
          fi
          git config user.name "${AUTHOR_LOGIN}"
          git config user.email "${AUTHOR_LOGIN}@users.noreply.github.com"
          git commit -m "${COMMIT_MESSAGE}"
          git push origin "${TARGET_REF}"
          popd >/dev/null
