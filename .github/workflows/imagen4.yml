name: imagen4-via-gemini-cli
on:
  workflow_dispatch:
    inputs:
      image_prompt:
        description: '作りたい画像のプロンプト'
        required: true
      model:
        description: '画像生成モデル (imagen-4 / imagen-4-ultra / imagen-3)'
        required: false
        default: 'imagen-4'
      num:
        description: '生成枚数'
        required: false
        default: '2'
      aspect_ratio:
        description: 'アスペクト比 (例: 1:1, 16:9, 9:16)'
        required: false
        default: '1:1'

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate images via Gemini CLI (+ Imagen MCP)
        uses: google-github-actions/run-gemini-cli@v0
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          gemini_model: gemini-2.5-flash        # 本体はテキスト思考用。画像生成はMCP側が担当
          gemini_debug: true
          # Gemini CLI のプロジェクト設定をその場で注入
          settings: |
            {
              "mcpServers": {
                "gemini-imagen": {
                  "command": "npx",
                  "args": ["-y", "gemini-imagen-mcp-server",
                           "--output-dir", "generated-images",
                           "--model", "${{ github.event.inputs.model }}"],
                  "env": { "GEMINI_API_KEY": "${{ secrets.GEMINI_API_KEY }}" },
                  "trust": true,
                  "includeTools": ["generate_image"]
                }
              }
            }
          # モデルに対する指示（MCPツールを明示的に使わせる）
          prompt: |
            Use the @gemini-imagen.generate_image tool to generate ${{ github.event.inputs.num }} image(s)
            from this prompt: "${{ github.event.inputs.image_prompt }}"
            Use aspect ratio "${{ github.event.inputs.aspect_ratio }}".
            Confirm files are saved under ./generated-images and list the filenames only.

      - name: Upload generated images
        uses: actions/upload-artifact@v4
        with:
          name: generated-images
          path: generated-images/**
