name: "ğŸ“ Gemini Release Notes"

on:
  push:
    tags:
      - "*"

permissions:
  contents: write

defaults:
  run:
    shell: bash

env:
  # ç’°å¢ƒå¤‰æ•°ã§åˆ¶å¾¡å¯èƒ½ãªè¨­å®š
  MAX_COMMITS: 300
  MAX_FILES: 500
  MAX_CONTRIBUTORS: 200
  MAX_DIFF_LINES: 2000  # æ–°è¦è¿½åŠ : å·®åˆ†ã®æœ€å¤§è¡Œæ•°

jobs:
  release-notes:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout default branch
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # ratchet:actions/checkout@v4
        with:
          ref: ${{ github.event.repository.default_branch }}
          fetch-depth: 0

      - name: Prepare context
        id: ctx
        env:
          REPOSITORY: "${{ github.repository }}"
          TAG_NAME: "${{ github.ref_name }}"
          GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
          MAX_COMMITS: "${{ env.MAX_COMMITS }}"
          MAX_FILES: "${{ env.MAX_FILES }}"
          MAX_CONTRIBUTORS: "${{ env.MAX_CONTRIBUTORS }}"
          MAX_DIFF_LINES: "${{ env.MAX_DIFF_LINES }}"
        run: |
          set -euo pipefail
          TAG="${TAG_NAME}"
          git fetch --tags --prune --force >/dev/null 2>&1 || true
          # Try to get previous released tag (from Releases). Fallback to previous git tag reachable from current.
          PREV_RELEASE_TAG="$(gh release list --limit 100 --json tagName --jq 'map(.tagName) | map(select(. != env.TAG)) | .[0]' || true)"
          if [[ -z "${PREV_RELEASE_TAG}" || "${PREV_RELEASE_TAG}" == "null" ]]; then
            PREV_RELEASE_TAG="$(git describe --tags --abbrev=0 "${TAG}^" 2>/dev/null || true)"
          fi
          BASE_RANGE=""
          COMPARE_URL=""
          if [[ -n "${PREV_RELEASE_TAG}" ]]; then
            BASE_RANGE="${PREV_RELEASE_TAG}..${TAG}"
            COMPARE_URL="https://github.com/${REPOSITORY}/compare/${PREV_RELEASE_TAG}...${TAG}"
          else
            # Initial release: include history up to the tag commit
            BASE_RANGE="${TAG}"
          fi
          # Collect data (trim to keep prompt concise)
          COMMITS="$(git log --no-merges --pretty=format:'- %s (%h) by %an' ${BASE_RANGE} | head -n ${MAX_COMMITS} || true)"
          CHANGED_FILES="$( ( [[ -n "${PREV_RELEASE_TAG}" ]] && git diff --name-only ${BASE_RANGE} || git ls-tree -r --name-only HEAD ) | sed 's/^/- /' | head -n ${MAX_FILES} || true)"
          CONTRIBUTORS="$(git log --format='%an' ${BASE_RANGE} | sort -u | sed 's/^/- /' | head -n ${MAX_CONTRIBUTORS} || true)"
          
          # ğŸ”¥ æ–°è¦è¿½åŠ : å®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰å·®åˆ†ã‚’å–å¾—
          echo "Collecting code diff (max ${MAX_DIFF_LINES} lines)..."
          if [[ -n "${PREV_RELEASE_TAG}" ]]; then
            # å‰ã®ãƒªãƒªãƒ¼ã‚¹ã¨ã®å·®åˆ†
            DIFF_CONTENT="$(git diff ${BASE_RANGE} | head -n ${MAX_DIFF_LINES} || true)"
            DIFF_STATS="$(git diff --stat ${BASE_RANGE} | head -n 100 || true)"
          else
            # åˆå›ãƒªãƒªãƒ¼ã‚¹: å…¨ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ï¼ˆåˆ¶é™ä»˜ãï¼‰
            DIFF_CONTENT="$(git show --format="" --name-status HEAD | head -n ${MAX_DIFF_LINES} || true)"
            DIFF_STATS="$(git ls-tree -r --name-only HEAD | wc -l) files in initial release"
          fi
          {
            echo "tag=${TAG}"
            echo "prev_tag=${PREV_RELEASE_TAG}"
            echo "compare_url=${COMPARE_URL}"
            echo 'commits<<EOF'
            echo "${COMMITS}"
            echo 'EOF'
            echo 'files<<EOF'
            echo "${CHANGED_FILES}"
            echo 'EOF'
            echo 'contributors<<EOF'
            echo "${CONTRIBUTORS}"
            echo 'EOF'
            echo 'diff_stats<<EOF'
            echo "${DIFF_STATS}"
            echo 'EOF'
            echo 'diff_content<<EOF'
            echo "${DIFF_CONTENT}"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"
          echo "âœ… Collected context:"
          echo "  - Commits: $(echo "${COMMITS}" | wc -l) entries"
          echo "  - Files: $(echo "${CHANGED_FILES}" | wc -l) entries"
          echo "  - Contributors: $(echo "${CONTRIBUTORS}" | wc -l) entries"
          echo "  - Diff content: $(echo "${DIFF_CONTENT}" | wc -l) lines"

      - name: Build release image prompt
        id: build_image_prompt
        env:
          TAG: "${{ steps.ctx.outputs.tag }}"
          REPOSITORY: "${{ github.repository }}"
        run: |
          set -euo pipefail
          TEMPLATE=".github/prompts/release-image.en.txt"
          if [[ ! -f "${TEMPLATE}" ]]; then
            echo "Prompt template not found: ${TEMPLATE}" >&2
            exit 1
          fi
          
          # Extract repository name and transform it
          # e.g., "owner/my-awesome-repo" -> "my-awesome-repo" -> "MY AWESOME REPO"
          REPO_NAME="${REPOSITORY##*/}"  # Remove owner/ prefix
          REPO_DISPLAY=$(echo "${REPO_NAME}" | tr '-' ' ' | tr '[:lower:]' '[:upper:]')
          
          echo "Repository: ${REPOSITORY}"
          echo "Repository name: ${REPO_NAME}" 
          echo "Display name: ${REPO_DISPLAY}"
          echo "Tag: ${TAG}"
          
          # Replace placeholders using environment variables for Perl
          # - v0.0.0 -> actual tag (e.g., v0.2.0)
          # - GEMINI ACTIONS LAB -> transformed repository name
          PROMPT=$(TAG="${TAG}" REPO_DISPLAY="${REPO_DISPLAY}" perl -pe '
            s/\bv0\.0\.0\b/\Q$ENV{TAG}\E/g;
            s/\bGEMINI ACTIONS LAB\b/\Q$ENV{REPO_DISPLAY}\E/g;
          ' "${TEMPLATE}")
          
          {
            echo 'image_prompt<<EOF'
            echo "${PROMPT}"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"
          
          echo "âœ… Processed image prompt template with replacements"

      - name: Create image output directory
        id: outdir
        run: |
          set -euo pipefail
          ts=$(date +%Y%m%d_%H%M%S)
          dir="generated-images/release-${{ steps.ctx.outputs.tag }}-${ts}"
          mkdir -p "${dir}"
          echo "OUTPUT_DIR=${dir}" >> "$GITHUB_OUTPUT"
          echo "Created ${dir}"

      - name: Generate release image via Gemini CLI (+ Imagen MCP)
        uses: google-github-actions/run-gemini-cli@v0
        env:
          IMAGE_PROMPT: "${{ steps.build_image_prompt.outputs.image_prompt }}"
        with:
          gemini_api_key: "${{ secrets.GEMINI_API_KEY }}"
          gemini_model: gemini-2.5-flash
          gemini_debug: true
          settings: |
            {
              "mcpServers": {
                "gemini-imagen": {
                  "command": "npx",
                  "args": ["-y", "gemini-imagen-mcp-server",
                           "--output-dir", "${{ steps.outdir.outputs.OUTPUT_DIR }}",
                           "--model", "imagen-4-ultra"],
                  "env": { "GEMINI_API_KEY": "${{ secrets.GEMINI_API_KEY }}" },
                  "trust": true,
                  "includeTools": ["generate_image"]
                }
              }
            }
          prompt: |
            Use the @gemini-imagen.generate_image tool to generate 1 image
            from this prompt: "${{ env.IMAGE_PROMPT }}".
            Use aspect ratio "16:9".
            Save files under ./${{ steps.outdir.outputs.OUTPUT_DIR }} and list only the filenames.

      - name: Verify release image files
        run: |
          set -euo pipefail
          dir="${{ steps.outdir.outputs.OUTPUT_DIR }}"
          if [[ ! -d "${dir}" ]]; then
            echo "${dir} not found"; exit 1
          fi
          echo "== Generated files =="
          ls -lh "${dir}"
          cnt=$(ls -1 "${dir}" | wc -l)
          if [[ "${cnt}" -lt 1 ]]; then
            echo "No images were generated"; exit 1
          fi
          echo "âœ… Successfully generated ${cnt} file(s)"

      - name: Add image metadata file
        run: |
          set -euo pipefail
          dir="${{ steps.outdir.outputs.OUTPUT_DIR }}"
          cat > "${dir}/metadata.json" << 'EOF'
          {
            "generation_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "prompt": "${{ steps.build_image_prompt.outputs.image_prompt }}",
            "model": "imagen-4-ultra",
            "num_images": 1,
            "aspect_ratio": "16:9",
            "seed": "",
            "workflow_run": "${{ github.run_number }}",
            "commit_sha": "${{ github.sha }}",
            "tag": "${{ steps.ctx.outputs.tag }}"
          }
          EOF
          echo "Created metadata file: ${dir}/metadata.json"

      - name: Commit and push release image
        run: |
          set -euo pipefail
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add "${{ steps.outdir.outputs.OUTPUT_DIR }}"/
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit \
              -m "ğŸ¨ Release image for ${{ steps.ctx.outputs.tag }}" \
              -m "Model: imagen-4-ultra" \
              -m "Images: 1" \
              -m "Aspect ratio: 16:9" \
              -m "Generated at: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            git push origin HEAD:${{ github.event.repository.default_branch }}
            echo "âœ… Committed release image"
          fi

      - name: Find header image and build raw URL
        id: header
        env:
          OUTPUT_DIR: "${{ steps.outdir.outputs.OUTPUT_DIR }}"
          REPOSITORY: "${{ github.repository }}"
          DEFAULT_BRANCH: "${{ github.event.repository.default_branch }}"
        run: |
          set -euo pipefail
          dir="${OUTPUT_DIR}"
          if [[ -d "${dir}" ]]; then
            # Find the first image file by common extensions
            img=$(ls -1 "${dir}" | grep -Ei '\.(png|jpg|jpeg)$' | head -n 1 || true)
            if [[ -n "${img:-}" ]]; then
              image_path="${dir}/${img}"
              image_name="${img}"
              # Build canonical raw URL: https://raw.githubusercontent.com/<owner>/<repo>/<branch>/<path>
              raw_url="https://raw.githubusercontent.com/${REPOSITORY}/${DEFAULT_BRANCH}/${image_path}"
              echo "image_path=${image_path}" >> "$GITHUB_OUTPUT"
              echo "image_name=${image_name}" >> "$GITHUB_OUTPUT"
              echo "raw_url=${raw_url}" >> "$GITHUB_OUTPUT"
              echo "Found header image: ${image_path}"
              echo "RAW URL: ${raw_url}"
            else
              echo "No image file found in ${dir}"
            fi
          else
            echo "Output dir not found: ${dir}"
          fi

      - name: Generate release notes with Gemini
        id: gemini
        uses: google-github-actions/run-gemini-cli@v0
        env:
          REPOSITORY: "${{ github.repository }}"
          TAG_NAME: "${{ steps.ctx.outputs.tag }}"
          PREV_TAG: "${{ steps.ctx.outputs.prev_tag }}"
          COMPARE_URL: "${{ steps.ctx.outputs.compare_url }}"
          COMMITS: "${{ steps.ctx.outputs.commits }}"
          CHANGED_FILES: "${{ steps.ctx.outputs.files }}"
          CONTRIBUTORS: "${{ steps.ctx.outputs.contributors }}"
          DIFF_STATS: "${{ steps.ctx.outputs.diff_stats }}"
          DIFF_CONTENT: "${{ steps.ctx.outputs.diff_content }}"
        with:
          gemini_api_key: "${{ secrets.GEMINI_API_KEY }}"
          gcp_workload_identity_provider: "${{ vars.GCP_WIF_PROVIDER }}"
          gcp_project_id: "${{ vars.GOOGLE_CLOUD_PROJECT }}"
          gcp_location: "${{ vars.GOOGLE_CLOUD_LOCATION }}"
          gcp_service_account: "${{ vars.SERVICE_ACCOUNT_EMAIL }}"
          use_vertex_ai: "${{ vars.GOOGLE_GENAI_USE_VERTEXAI }}"
          use_gemini_code_assist: "${{ vars.GOOGLE_GENAI_USE_GCA }}"
          settings: |
            { "debug": false, "maxSessionTurns": 10, "telemetry": { "enabled": false, "target": "gcp" } }
          prompt: |
            ã‚ãªãŸã¯ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆä½œæˆã®ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã§ã™ã€‚ä»¥ä¸‹ã®æƒ…å ±ã‹ã‚‰ã€æ—¥æœ¬èªã§èª­ã¿ã‚„ã™ã„Markdownã®ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
            # ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
            - ãƒªãƒã‚¸ãƒˆãƒª: ${{ github.repository }}
            - ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚°: ${{ steps.ctx.outputs.tag }}
            - å‰ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚°: ${{ steps.ctx.outputs.prev_tag }}
            - æ¯”è¼ƒURL: ${{ steps.ctx.outputs.compare_url }}
            # å¤‰æ›´çµ±è¨ˆ
            ${{ steps.ctx.outputs.diff_stats }}
            # ã‚³ãƒ¼ãƒ‰å·®åˆ†ï¼ˆå®Ÿéš›ã®å¤‰æ›´å†…å®¹ï¼‰
            ```diff
            ${{ steps.ctx.outputs.diff_content }}
            ```
            # å¤‰æ›´ã‚³ãƒŸãƒƒãƒˆï¼ˆæŠœç²‹ï¼‰
            ${{ steps.ctx.outputs.commits }}
            # å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆæŠœç²‹ï¼‰
            ${{ steps.ctx.outputs.files }}
            # ã‚³ãƒ³ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚¿ãƒ¼ï¼ˆæŠœç²‹ï¼‰
            ${{ steps.ctx.outputs.contributors }}
            # åŸ·ç­†æ–¹é‡
            - **ã‚³ãƒ¼ãƒ‰å·®åˆ†ã‚’å¿…ãšå‚ç…§**ã—ã¦ã€å®Ÿéš›ã®å¤‰æ›´å†…å®¹ã‚’æ­£ç¢ºã«æŠŠæ¡ã—ã¦ã‹ã‚‰ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’ä½œæˆã™ã‚‹
            - è¦‹å‡ºã—ã¨ç®‡æ¡æ›¸ãã‚’ç”¨ã„ã¦ç°¡æ½”ã«
            - ä¸»ãªå¤‰æ›´ç‚¹(Highlights)ã€Breaking Changesï¼ˆã‚ã‚Œã°ï¼‰ã€æ”¹å–„ãƒ»ä¿®æ­£ã€è²¢çŒ®è€…ã®é †ã§ã¾ã¨ã‚ã‚‹
            - å¯èƒ½ãªã‚‰Conventional Commitsã‚’æ‰‹æ›ã‹ã‚Šã«åˆ†é¡ï¼ˆfeat/fix/docs/chore/refactor/perf/test ç­‰ï¼‰
            - ã‚³ãƒ¼ãƒ‰å·®åˆ†ã‹ã‚‰é‡å¤§å¤‰æ›´ï¼ˆAPIå¤‰æ›´ã€å‰Šé™¤ã•ã‚ŒãŸæ©Ÿèƒ½ç­‰ï¼‰ã‚’æ¤œå‡ºã—ã€ŒBreaking Changesã€ã«æ˜è¨˜
            - æ–°æ©Ÿèƒ½ã€ãƒã‚°ä¿®æ­£ã€æ”¹å–„ç‚¹ã‚’å·®åˆ†ã‹ã‚‰å…·ä½“çš„ã«æŠ½å‡º
            - æœ€å¾Œã«æ¯”è¼ƒURLã‚’è¨˜è¼‰
            - å‡ºåŠ›ã¯Markdownã®ã¿ï¼ˆä½™è¨ˆãªå‰ç½®ãã‚„å¾Œæ›¸ãã€ã‚³ãƒ¼ãƒ‰ãƒ•ã‚§ãƒ³ã‚¹ã¯ä¸è¦ï¼‰
            # æœŸå¾…ã™ã‚‹Markdownã®æ§‹æˆä¾‹
            # ${{ steps.ctx.outputs.tag }} ï½ã“ã®ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã®å†…å®¹ãŒåˆ†ã‹ã‚‹ã‚ˆã†ãªã‚¿ã‚¤ãƒˆãƒ«ï½
            
            ## âœ¨ Highlights
            - ä¸»è¦ãªå¤‰æ›´ç‚¹ã®è¦ç´„ï¼ˆã‚³ãƒ¼ãƒ‰å·®åˆ†ã‹ã‚‰åˆ¤æ–­ï¼‰
            ## ğŸ’¥ Breaking Changes
            - é‡å¤§ãªå¤‰æ›´ç‚¹ï¼ˆAPIå¤‰æ›´ã€å‰Šé™¤ã•ã‚ŒãŸæ©Ÿèƒ½ç­‰ã‚’ã‚³ãƒ¼ãƒ‰å·®åˆ†ã‹ã‚‰æ¤œå‡ºï¼‰
            ## ğŸ›  å¤‰æ›´ä¸€è¦§
            ### âœ¨ Features (feat)
            - æ–°æ©Ÿèƒ½ã®è©³ç´°ï¼ˆã‚³ãƒ¼ãƒ‰å·®åˆ†ã‹ã‚‰åˆ¤æ–­ï¼‰
            ### ğŸ› Bug Fixes (fix)  
            - ä¿®æ­£å†…å®¹ã®è©³ç´°ï¼ˆã‚³ãƒ¼ãƒ‰å·®åˆ†ã‹ã‚‰åˆ¤æ–­ï¼‰
            ### ğŸ“š Documentation (docs)
            - ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°å†…å®¹
            ### ğŸ”§ Maintenance (chore/refactor)
            - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã‚„ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹å†…å®¹
            ## ğŸ‘¥ Contributors
            - ãƒ¦ãƒ¼ã‚¶ãƒ¼åä¸€è¦§ï¼ˆæŠœç²‹ï¼‰
            ---
            æ¯”è¼ƒ: ${{ steps.ctx.outputs.compare_url }}

      # ğŸ†• æ–°è¦è¿½åŠ : Zennè¨˜äº‹ç”Ÿæˆã‚¹ãƒ†ãƒƒãƒ—
      - name: Generate Zenn article with Gemini
        id: zenn_article
        uses: google-github-actions/run-gemini-cli@v0
        env:
          REPOSITORY: "${{ github.repository }}"
          TAG_NAME: "${{ steps.ctx.outputs.tag }}"
          PREV_TAG: "${{ steps.ctx.outputs.prev_tag }}"
          COMPARE_URL: "${{ steps.ctx.outputs.compare_url }}"
          COMMITS: "${{ steps.ctx.outputs.commits }}"
          CHANGED_FILES: "${{ steps.ctx.outputs.files }}"
          CONTRIBUTORS: "${{ steps.ctx.outputs.contributors }}"
          DIFF_STATS: "${{ steps.ctx.outputs.diff_stats }}"
          DIFF_CONTENT: "${{ steps.ctx.outputs.diff_content }}"
          RELEASE_NOTES: "${{ steps.gemini.outputs.summary }}"
          HEADER_IMAGE_URL: "${{ steps.header.outputs.raw_url }}"
          HEADER_IMAGE_NAME: "${{ steps.header.outputs.image_name }}"
        with:
          gemini_api_key: "${{ secrets.GEMINI_API_KEY }}"
          gcp_workload_identity_provider: "${{ vars.GCP_WIF_PROVIDER }}"
          gcp_project_id: "${{ vars.GOOGLE_CLOUD_PROJECT }}"
          gcp_location: "${{ vars.GOOGLE_CLOUD_LOCATION }}"
          gcp_service_account: "${{ vars.SERVICE_ACCOUNT_EMAIL }}"
          use_vertex_ai: "${{ vars.GOOGLE_GENAI_USE_VERTEXAI }}"
          use_gemini_code_assist: "${{ vars.GOOGLE_GENAI_USE_GCA }}"
          settings: |
            { "debug": false, "maxSessionTurns": 10, "telemetry": { "enabled": false, "target": "gcp" } }
          prompt: |
            ã‚ãªãŸã¯Zennã®æŠ€è¡“è¨˜äº‹ä½œæˆã®ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã§ã™ã€‚ä»¥ä¸‹ã®æƒ…å ±ã‹ã‚‰ã€ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’å…ƒã«ã—ãŸZennè¨˜äº‹ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
            
            # ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
            - ãƒªãƒã‚¸ãƒˆãƒª: ${{ github.repository }}
            - ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚°: ${{ steps.ctx.outputs.tag }}
            - å‰ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚°: ${{ steps.ctx.outputs.prev_tag }}
            - æ¯”è¼ƒURL: ${{ steps.ctx.outputs.compare_url }}
            - ãƒ˜ãƒƒãƒ€ãƒ¼ç”»åƒURL: ${{ steps.header.outputs.raw_url }}
            - ãƒ˜ãƒƒãƒ€ãƒ¼ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«å: ${{ steps.header.outputs.image_name }}
            
            # ç”Ÿæˆæ¸ˆã¿ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆ
            ${{ steps.gemini.outputs.summary }}
            
            # å¤‰æ›´çµ±è¨ˆ
            ${{ steps.ctx.outputs.diff_stats }}
            
            # ã‚³ãƒ¼ãƒ‰å·®åˆ†ï¼ˆå®Ÿéš›ã®å¤‰æ›´å†…å®¹ï¼‰
            ```diff
            ${{ steps.ctx.outputs.diff_content }}
            ```
            
            # å¤‰æ›´ã‚³ãƒŸãƒƒãƒˆï¼ˆæŠœç²‹ï¼‰
            ${{ steps.ctx.outputs.commits }}
            
            # å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆæŠœç²‹ï¼‰
            ${{ steps.ctx.outputs.files }}
            
            # åŸ·ç­†æ–¹é‡
            - **ãƒªãƒã‚¸ãƒˆãƒªåã‹ã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’æ¨æ¸¬ã—ã€é©åˆ‡ãªã‚¿ã‚¤ãƒˆãƒ«ã‚’ä½œæˆã™ã‚‹**
            - **topicsé…åˆ—ã«ã¯æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ã€è¨€èªã€ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ãªã©é–¢é€£ã™ã‚‹æŠ€è¡“ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’4ã¤ç¨‹åº¦è¨­å®šã™ã‚‹**
            - **emojiã¯å†…å®¹ã«å¿œã˜ã¦é©åˆ‡ãªã‚‚ã®ã‚’é¸æŠã™ã‚‹**
            - **ã‚³ãƒ¼ãƒ‰å·®åˆ†ã‚’åˆ†æã—ã€æŠ€è¡“çš„ãªå¤‰æ›´ç‚¹ã‚’è©³ã—ãèª¬æ˜ã™ã‚‹**
            - **é–‹ç™ºè€…å‘ã‘ã«å…·ä½“çš„ã§å®Ÿç”¨çš„ãªå†…å®¹ã«ã™ã‚‹**
            - **ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã®å†…å®¹ã‚’ãƒ™ãƒ¼ã‚¹ã«ã€ã‚ˆã‚Šè©³ç´°ã§èª­ã¿ã‚„ã™ã„æŠ€è¡“è¨˜äº‹ã¨ã—ã¦å±•é–‹ã™ã‚‹**
            - **ãƒ˜ãƒƒãƒ€ãƒ¼ç”»åƒURLï¼ˆ${{ steps.header.outputs.raw_url }}ï¼‰ãŒã‚ã‚Œã°ã€frontmatterã®ç›´å¾Œã«Markdownã§è¡¨ç¤ºã™ã‚‹**
            
            # å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            **å¿…ãšè¨˜äº‹å…¨ä½“ã‚’<article>ã‚¿ã‚°ã§å›²ã‚“ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š**
            
            <article>
            ---
            title: "ã€ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã€‘[ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå] ${{ steps.ctx.outputs.tag }} - [ä¸»è¦ãªå¤‰æ›´ç‚¹ã‚’ä¸€è¨€ã§]"
            emoji: "ğŸš€"
            type: "tech"
            topics: ['æŠ€è¡“1', 'æŠ€è¡“2', 'æŠ€è¡“3', 'æŠ€è¡“4']
            published: true
            ---
            
            [ãƒ˜ãƒƒãƒ€ãƒ¼ç”»åƒãŒã‚ã‚‹å ´åˆ: ![image_name](image_url)]
            
            ## ã¯ã˜ã‚ã«
            [ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ç°¡å˜ãªèª¬æ˜ã¨ãƒªãƒªãƒ¼ã‚¹ã®æ¦‚è¦]
            
            ## ä¸»ãªå¤‰æ›´ç‚¹
            [ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’å…ƒã«ã—ãŸè©³ç´°ãªèª¬æ˜]
            
            ## æŠ€è¡“çš„ãªè©³ç´°
            [ã‚³ãƒ¼ãƒ‰å·®åˆ†ã‹ã‚‰èª­ã¿å–ã‚Œã‚‹æŠ€è¡“çš„ãªå¤‰æ›´ç‚¹ã®è©³ç´°]
            
            ### æ–°æ©Ÿèƒ½
            [æ–°æ©Ÿèƒ½ã®è©³ç´°èª¬æ˜]
            
            ### æ”¹å–„ç‚¹
            [æ”¹å–„ç‚¹ã®è©³ç´°èª¬æ˜]
            
            ### ãƒã‚°ä¿®æ­£
            [ãƒã‚°ä¿®æ­£ã®è©³ç´°èª¬æ˜]
            
            ## ã¾ã¨ã‚
            [ä»Šå›ã®ãƒªãƒªãƒ¼ã‚¹ã®ã¾ã¨ã‚ã¨ä»Šå¾Œã®å±•æœ›]
            
            ---
            
            ğŸ“š **å‚è€ƒãƒªãƒ³ã‚¯**
            - [ãƒªãƒã‚¸ãƒˆãƒª](https://github.com/${{ github.repository }})
            - [æ¯”è¼ƒè¡¨ç¤º](${{ steps.ctx.outputs.compare_url }})
            - [ãƒªãƒªãƒ¼ã‚¹ãƒšãƒ¼ã‚¸](https://github.com/${{ github.repository }}/releases/tag/${{ steps.ctx.outputs.tag }})
            </article>
            
            **é‡è¦**: å¿…ãš<article>é–‹å§‹ã‚¿ã‚°ã‹ã‚‰</article>çµ‚äº†ã‚¿ã‚°ã¾ã§ã§è¨˜äº‹å…¨ä½“ã‚’å›²ã‚“ã§ãã ã•ã„ã€‚

      - name: Checkout Zenn repository
        uses: actions/checkout@v4
        with:
          repository: 'Sunwood-ai-labs/Zenn'
          token: ${{ secrets.ZENN_REPO_TOKEN }}
          path: 'zenn-repo'

      - name: Create Zenn article file
        env:
          TAG: "${{ steps.ctx.outputs.tag }}"
          REPOSITORY: "${{ github.repository }}"
          ZENN_CONTENT: "${{ steps.zenn_article.outputs.summary }}"
          GITHUB_TOKEN: "${{ secrets.ZENN_REPO_TOKEN }}"
          HEADER_IMAGE_URL: "${{ steps.header.outputs.raw_url }}"
          HEADER_IMAGE_NAME: "${{ steps.header.outputs.image_name }}"
        run: |
          set -euo pipefail
          # ãƒªãƒã‚¸ãƒˆãƒªåã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç”Ÿæˆ
          REPO_NAME="${REPOSITORY##*/}"  # Remove owner/ prefix
          TAG_CLEAN="${TAG#v}"  # Remove 'v' prefix if present
          TIMESTAMP=$(date +%Y%m%d)
          # ãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆæ‹¡å¼µå­ã‚’é™¤ãï¼‰ã¯Zennè¨˜äº‹ã®slugã¨ãªã‚‹ãŸã‚ã€åˆ¶ç´„ã«åˆã‚ã›ã¦ç”Ÿæˆ
          RAW_SLUG="${TIMESTAMP}-${REPO_NAME}-${TAG_CLEAN}-release"
          RAW_SLUG="${RAW_SLUG,,}"  # å°æ–‡å­—åŒ–
          # ä½¿ç”¨å¯èƒ½æ–‡å­—ï¼ˆa-z0-9_-ï¼‰ä»¥å¤–ã‚’ãƒã‚¤ãƒ•ãƒ³ã«ç½®æ›ã—ã€ãƒã‚¤ãƒ•ãƒ³ãƒ»ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã®é€£ç¶šã‚’æ•´ç†
          SLUG=$(echo "${RAW_SLUG}" \
            | sed 's/[^a-z0-9_-]/-/g' \
            | sed -E 's/-{2,}/-/g' \
            | sed -E 's/_{2,}/_/g' \
            | sed -E 's/^[-_]+//; s/[-_]+$//')
          # ç”ŸæˆçµæœãŒç©ºã®å ´åˆã¯æ—¥ä»˜ãƒ™ãƒ¼ã‚¹ã®slugã‚’ä½¿ç”¨
          if [[ -z "${SLUG}" ]]; then
            SLUG="${TIMESTAMP}-release"
          fi
          # æœ€å¤§æ–‡å­—æ•°ï¼ˆ50æ–‡å­—ï¼‰ã‚’è¶…ãˆã‚‹å ´åˆã¯ãƒˆãƒªãƒŸãƒ³ã‚°ã—ã€æœ«å°¾ã®ãƒã‚¤ãƒ•ãƒ³/ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã‚’é™¤å»
          if [[ ${#SLUG} -gt 50 ]]; then
            SLUG="${SLUG:0:50}"
            SLUG=$(echo "${SLUG}" | sed -E 's/[-_]+$//')
          fi
          # æœ€å°æ–‡å­—æ•°ï¼ˆ12æ–‡å­—ï¼‰ã«æº€ãŸãªã„å ´åˆã¯è¨±å®¹æ–‡å­—ã§ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°
          while [[ ${#SLUG} -lt 12 ]]; do
            SLUG="${SLUG}x"
          done
          # æœ€çµ‚çš„ãªslugãŒåˆ¶ç´„ã‚’æº€ãŸã™ã‹æ¤œè¨¼
          if [[ ! "${SLUG}" =~ ^[a-z0-9_-]{12,50}$ ]]; then
            echo "ç”Ÿæˆã•ã‚ŒãŸslug '${SLUG}' ãŒåˆ¶ç´„ã‚’æº€ãŸã—ã¾ã›ã‚“" >&2
            exit 1
          fi
          FILENAME="${SLUG}.md"
          FILEPATH="zenn-repo/articles/${FILENAME}"
          echo "Creating Zenn article: ${FILEPATH}"
          
          # articlesãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
          mkdir -p "zenn-repo/articles"
          
          # Zennè¨˜äº‹ã‚’ä½œæˆï¼ˆ<article>ã‚¿ã‚°ã‹ã‚‰ä¸­èº«ã‚’æŠ½å‡ºï¼‰
          if echo "${ZENN_CONTENT}" | grep -q '<article>'; then
            # <article>ã‚¿ã‚°ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ä¸­èº«ã‚’æŠ½å‡º
            # æœ€åˆã®<article>ã‹ã‚‰æœ€å¾Œã®</article>ã¾ã§ã‚’æŠ½å‡ºï¼ˆè²ªæ¬²ãƒãƒƒãƒãƒ³ã‚°ï¼‰
            echo "${ZENN_CONTENT}" | perl -0777 -pe 's/^.*?<article>\s*(.*)\s*<\/article>.*$/\1/s' > "${FILEPATH}"
            echo "âœ… Created Zenn article: ${FILENAME} (extracted from article tags)"
          else
            # <article>ã‚¿ã‚°ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ãã®ã¾ã¾ä½¿ç”¨
            echo "${ZENN_CONTENT}" > "${FILEPATH}"
            echo "âœ… Created Zenn article: ${FILENAME} (used as-is)"
          fi
          echo "File size: $(wc -c < "${FILEPATH}") bytes"
          
          # å‡ºåŠ›å¤‰æ•°ã«ãƒ•ã‚¡ã‚¤ãƒ«åã‚’è¨­å®š
          echo "zenn_filename=${FILENAME}" >> "$GITHUB_OUTPUT"
          echo "zenn_filepath=${FILEPATH}" >> "$GITHUB_OUTPUT"

      - name: Commit and push Zenn article
        env:
          TAG: "${{ steps.ctx.outputs.tag }}"
          REPOSITORY: "${{ github.repository }}"
          GITHUB_TOKEN: "${{ secrets.ZENN_REPO_TOKEN }}"
        run: |
          set -euo pipefail
          cd zenn-repo
          
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add articles/
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit \
              -m "ğŸ“ Add release article for ${REPOSITORY} ${TAG}" \
              -m "Generated from: ${REPOSITORY}/releases/tag/${TAG}" \
              -m "Generated at: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            git push
            echo "âœ… Committed and pushed Zenn article"
          fi

      - name: Write notes to file (with header image)
        env:
          HEADER_URL: "${{ steps.header.outputs.raw_url }}"
          IMAGE_NAME: "${{ steps.header.outputs.image_name }}"
        run: |
          set -euo pipefail
          : > release_notes.md
          if [[ -n "${HEADER_URL}" && -n "${IMAGE_NAME}" ]]; then
            {
              # Image first at the very top
              echo "![${IMAGE_NAME}](${HEADER_URL})"
              echo
              echo "#### ãƒ˜ãƒƒãƒ€ãƒ¼ç”»åƒ: ${IMAGE_NAME}"
              echo "[ğŸ”— ç›´æ¥ãƒªãƒ³ã‚¯](${HEADER_URL})"
              echo
            } >> release_notes.md
          fi
          # Append the model-generated notes without expanding variables
          cat >> release_notes.md << 'EOF'
          ${{ steps.gemini.outputs.summary }}
          EOF
          echo "Wrote release_notes.md (size: $(wc -c < release_notes.md) bytes)"

      - name: Create or update GitHub Release
        env:
          GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
          TAG: "${{ steps.ctx.outputs.tag }}"
        run: |
          set -euo pipefail
          if gh release view "${TAG}" >/dev/null 2>&1; then
            gh release edit "${TAG}" --notes-file release_notes.md
          else
            # Mark pre-releases automatically if tag contains pre-release identifiers
            PRERELEASE_FLAG=""
            if [[ "${TAG}" =~ -(alpha|beta|rc) ]]; then PRERELEASE_FLAG="--prerelease"; fi
            gh release create "${TAG}" --title "${TAG}" --notes-file release_notes.md ${PRERELEASE_FLAG}
          fi

      - name: Upload header image to Release assets
        env:
          GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
          TAG: "${{ steps.ctx.outputs.tag }}"
          IMAGE_FILE: "${{ steps.header.outputs.image_path }}"
        run: |
          set -euo pipefail
          if [[ -n "${IMAGE_FILE}" && -f "${IMAGE_FILE}" ]]; then
            gh release upload "${TAG}" "${IMAGE_FILE}" --clobber
            echo "âœ… Uploaded header image asset: ${IMAGE_FILE}"
          else
            echo "No header image to upload"
          fi
