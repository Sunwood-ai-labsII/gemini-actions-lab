name: "ğŸ¨ imagen4-via-issue-comment"

on:
  issue_comment:
    types: [created]
  issues:
    types: [opened, edited]

jobs:
  check_trigger:
    runs-on: ubuntu-latest
    outputs:
      should_generate: ${{ steps.parse.outputs.should_generate }}
      image_prompt: ${{ steps.parse.outputs.image_prompt }}
      model: ${{ steps.parse.outputs.model }}
      num: ${{ steps.parse.outputs.num }}
      aspect_ratio: ${{ steps.parse.outputs.aspect_ratio }}
      seed: ${{ steps.parse.outputs.seed }}
    steps:
      - name: Parse comment for image generation command
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment?.body || context.payload.issue?.body || '';
            console.log('Comment body:', comment);
            
            // ã‚³ãƒãƒ³ãƒ‰ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
            const patterns = [
              /\/imagen4\s+(.+)/i,
              /@imagen4\s+(.+)/i
            ];
            
            let match = null;
            for (const pattern of patterns) {
              match = comment.match(pattern);
              if (match) break;
            }
            
            if (!match) {
              console.log('No image generation command found');
              core.setOutput('should_generate', 'false');
              return;
            }
            
            console.log('Found command:', match[0]);
            core.setOutput('should_generate', 'true');
            
            // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æŠ½å‡º
            let prompt = match[1].trim();
            
            // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è§£æ
            let model = 'imagen-4';
            let num = '2';
            let aspectRatio = '1:1';
            let seed = '';
            
            // model:å€¤ ã®å½¢å¼ã§ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŠ½å‡º
            const modelMatch = comment.match(/model:\s*([^\s,]+)/i);
            if (modelMatch) model = modelMatch[1];
            
            const numMatch = comment.match(/num:\s*(\d+)/i);
            if (numMatch) num = numMatch[1];
            
            const ratioMatch = comment.match(/ratio:\s*([^\s,]+)/i);
            if (ratioMatch) aspectRatio = ratioMatch[1];
            
            const seedMatch = comment.match(/seed:\s*([^\s,]+)/i);
            if (seedMatch) seed = seedMatch[1];
            
            // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‹ã‚‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿éƒ¨åˆ†ã‚’é™¤å»
            prompt = prompt.replace(/\s*(model|num|ratio|seed):\s*[^\s,]+/gi, '').trim();
            
            console.log('Parsed parameters:', {
              prompt, model, num, aspectRatio, seed
            });
            
            core.setOutput('image_prompt', prompt);
            core.setOutput('model', model);
            core.setOutput('num', num);
            core.setOutput('aspect_ratio', aspectRatio);
            core.setOutput('seed', seed);

  generate_and_commit:
    needs: check_trigger
    runs-on: ubuntu-latest
    if: needs.check_trigger.outputs.should_generate == 'true'
    
    permissions:
      contents: write
      issues: write
      pull-requests: write
      
    steps:
      - name: Add reaction to trigger comment
        uses: actions/github-script@v7
        with:
          script: |
            if (context.payload.comment) {
              await github.rest.reactions.createForIssueComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: context.payload.comment.id,
                content: 'eyes'
              });
            }

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create output directory
        run: |
          timestamp=$(date +%Y%m%d_%H%M%S)
          issue_number="${{ github.event.issue.number }}"
          dir_name="generated-images/issue-${issue_number}-${timestamp}"
          mkdir -p "$dir_name"
          echo "OUTPUT_DIR=$dir_name" >> $GITHUB_ENV
          echo "Created directory: $dir_name"

      - name: Generate images via Gemini CLI (+ Imagen MCP)
        uses: google-github-actions/run-gemini-cli@v0
        env:
          NUM: ${{ needs.check_trigger.outputs.num }}
          PROMPT: ${{ needs.check_trigger.outputs.image_prompt }}
          AR: ${{ needs.check_trigger.outputs.aspect_ratio }}
          SEED: ${{ needs.check_trigger.outputs.seed }}
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          gemini_model: gemini-2.5-flash
          gemini_debug: true
          settings: |
            {
              "mcpServers": {
                "gemini-imagen": {
                  "command": "npx",
                  "args": ["-y", "gemini-imagen-mcp-server",
                           "--output-dir", "${{ env.OUTPUT_DIR }}",
                           "--model", "${{ needs.check_trigger.outputs.model }}"],
                  "env": { "GEMINI_API_KEY": "${{ secrets.GEMINI_API_KEY }}" },
                  "trust": true,
                  "includeTools": ["generate_image"]
                }
              }
            }
          prompt: |
            Use the @gemini-imagen.generate_image tool to generate ${{ needs.check_trigger.outputs.num }} image(s)
            from this prompt: "${{ needs.check_trigger.outputs.image_prompt }}".
            Use aspect ratio "${{ needs.check_trigger.outputs.aspect_ratio }}".
            ${{ needs.check_trigger.outputs.seed != '' && format('If a seed is provided, use it: "{0}".', needs.check_trigger.outputs.seed) || '' }}
            Save files under ./${{ env.OUTPUT_DIR }} and list only the filenames.

      - name: Verify generated files
        run: |
          set -euo pipefail
          if [ ! -d "$OUTPUT_DIR" ]; then
            echo "$OUTPUT_DIR not found"; exit 1
          fi
          echo "== Generated files =="
          ls -lh "$OUTPUT_DIR"
          cnt=$(ls -1 "$OUTPUT_DIR" | wc -l)
          if [ "$cnt" -lt 1 ]; then
            echo "No images were generated"; exit 1
          fi
          echo "âœ… Successfully generated $cnt file(s)"
          echo "FILE_COUNT=$cnt" >> $GITHUB_ENV

      - name: Add metadata file
        run: |
          cat > "$OUTPUT_DIR/metadata.json" << EOF
          {
            "generation_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "prompt": "${{ needs.check_trigger.outputs.image_prompt }}",
            "model": "${{ needs.check_trigger.outputs.model }}",
            "num_images": ${{ needs.check_trigger.outputs.num }},
            "aspect_ratio": "${{ needs.check_trigger.outputs.aspect_ratio }}",
            "seed": "${{ needs.check_trigger.outputs.seed }}",
            "workflow_run": "${{ github.run_number }}",
            "commit_sha": "${{ github.sha }}",
            "issue_number": ${{ github.event.issue.number }},
            "triggered_by": "${{ github.event.comment && github.event.comment.user.login || github.event.issue.user.login }}"
          }
          EOF
          echo "Created metadata file:"
          cat "$OUTPUT_DIR/metadata.json"

      - name: Commit and push generated images
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add "$OUTPUT_DIR/"
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ğŸ¨ Generate images for issue #${{ github.event.issue.number }}
            
            Prompt: ${{ needs.check_trigger.outputs.image_prompt }}
            Model: ${{ needs.check_trigger.outputs.model }}
            Images: ${{ needs.check_trigger.outputs.num }}
            Aspect ratio: ${{ needs.check_trigger.outputs.aspect_ratio }}
            Seed: ${{ needs.check_trigger.outputs.seed }}
            Triggered by: @${{ github.event.comment && github.event.comment.user.login || github.event.issue.user.login }}
            Generated at: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            
            git push
            echo "âœ… Successfully committed and pushed generated images"
          fi

      - name: Upload generated images as artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: generated-images-issue-${{ github.event.issue.number }}-${{ github.run_number }}
          path: ${{ env.OUTPUT_DIR }}/
          retention-days: 30

      - name: Comment on issue with results
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            const outputDir = process.env.OUTPUT_DIR;
            const fileCount = process.env.FILE_COUNT || '0';
            const repoOwner = context.repo.owner;
            const repoName = context.repo.repo;
            const branch = 'main'; // ã¾ãŸã¯ context.ref.replace('refs/heads/', '')
            
            let commentBody = `## ğŸ¨ ç”»åƒç”Ÿæˆå®Œäº†\n\n`;
            commentBody += `**ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ:** ${{ needs.check_trigger.outputs.image_prompt }}\n`;
            commentBody += `**ãƒ¢ãƒ‡ãƒ«:** ${{ needs.check_trigger.outputs.model }}\n`;
            commentBody += `**ç”Ÿæˆæšæ•°:** ${fileCount}\n`;
            commentBody += `**ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”:** ${{ needs.check_trigger.outputs.aspect_ratio }}\n`;
            commentBody += `**ã‚·ãƒ¼ãƒ‰:** ${{ needs.check_trigger.outputs.seed || 'ãƒ©ãƒ³ãƒ€ãƒ ' }}\n\n`;
            
            if (fs.existsSync(outputDir)) {
              const files = fs.readdirSync(outputDir).filter(f => f.endsWith('.png') || f.endsWith('.jpg') || f.endsWith('.jpeg'));
              if (files.length > 0) {
                commentBody += `### ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«\n`;
                files.forEach(file => {
                  const relativePath = path.join(outputDir, file).replace(/\\/g, '/');
                  const rawUrl = `https://raw.githubusercontent.com/${repoOwner}/${repoName}/refs/heads/${branch}/${relativePath}`;
                  commentBody += `- [${file}](${rawUrl})\n`;
                });
                commentBody += `\nğŸ“ [ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n`;
              } else {
                commentBody += `âŒ ç”»åƒã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n`;
              }
            } else {
              commentBody += `âŒ å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚\n`;
            }
            
            commentBody += `\n---\n*Workflow run: [${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: commentBody
            });

      - name: Add success reaction
        uses: actions/github-script@v7
        if: success() && github.event.comment
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: '+1'
            });

      - name: Add failure reaction
        uses: actions/github-script@v7
        if: failure() && github.event.comment
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: '-1'
            });
