name: 'ğŸ’¬ Gemini CLI (æ—¥æœ¬èªç‰ˆ)'

on:
  issues:
    types:
      - 'opened'
  pull_request_review_comment:
    types:
      - 'created'
  pull_request_review:
    types:
      - 'submitted'
  issue_comment:
    types:
      - 'created'

concurrency:
  group: '${{ github.workflow }}-${{ github.event.issue.number }}'
  cancel-in-progress: |-
    ${{ github.event.sender.type == 'User' && ( github.event.issue.author_association == 'OWNER' || github.event.issue.author_association == 'MEMBER' || github.event.issue.author_association == 'COLLABORATOR') }}

defaults:
  run:
    shell: 'bash'

permissions:
  contents: 'write'
  id-token: 'write'
  pull-requests: 'write'
  issues: 'write'

jobs:
  gemini-cli-jp:
    if: |-
      github.event_name == 'workflow_dispatch' ||
      (
        github.event_name == 'issues' && github.event.action == 'opened' &&
        (contains(github.event.issue.body, '@gemini-jp-cli') || contains(github.event.issue.body, '@gemini-cli-jp')) &&
        !contains(github.event.issue.body, '@gemini-jp-cli /review') &&
        !contains(github.event.issue.body, '@gemini-jp-cli /triage') &&
        (
          github.event.repository.private == true ||
          contains(fromJSON('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.issue.author_association)
        )
      ) ||
      (
        (
          github.event_name == 'issue_comment' ||
          github.event_name == 'pull_request_review_comment'
        ) &&
        (contains(github.event.comment.body, '@gemini-jp-cli') || contains(github.event.comment.body, '@gemini-cli-jp')) &&
        !contains(github.event.comment.body, '@gemini-jp-cli /review') &&
        !contains(github.event.comment.body, '@gemini-jp-cli /triage') &&
        (
          github.event.repository.private == true ||
          contains(fromJSON('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.comment.author_association)
        )
      ) ||
      (
        github.event_name == 'pull_request_review' &&
        (contains(github.event.review.body, '@gemini-jp-cli') || contains(github.event.review.body, '@gemini-cli-jp')) &&
        !contains(github.event.review.body, '@gemini-jp-cli /review') &&
        !contains(github.event.review.body, '@gemini-jp-cli /triage') &&
        (
          github.event.repository.private == true ||
          contains(fromJSON('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.review.author_association)
        )
      )
    timeout-minutes: 10
    runs-on: 'ubuntu-latest'
    steps:
      - name: 'ğŸ› ãƒ‡ãƒãƒƒã‚°: ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã‚’å‡ºåŠ›'
        run: |-
          echo "=== ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´° ==="
          echo "Event Name: ${{ github.event_name }}"
          echo "Event Action: ${{ github.event.action }}"
          echo "Repository: ${{ github.repository }}"
          echo "Actor: ${{ github.actor }}"
          echo ""
          echo "=== Issueæƒ…å ± ==="
          echo "Issue Number: ${{ github.event.issue.number || 'N/A' }}"
          echo "Issue Title: ${{ github.event.issue.title || 'N/A' }}"
          echo "Issue Body Length: $(echo '${{ github.event.issue.body || '' }}' | wc -c)"
          echo "Issue Author: ${{ github.event.issue.user.login || 'N/A' }}"
          echo "Issue Association: ${{ github.event.issue.author_association || 'N/A' }}"
          echo ""
          echo "=== Commentæƒ…å ± ==="
          echo "Comment Body Length: $(echo '${{ github.event.comment.body || '' }}' | wc -c)"
          echo "Comment Author: ${{ github.event.comment.user.login || 'N/A' }}"
          echo "Comment Association: ${{ github.event.comment.author_association || 'N/A' }}"
          echo ""
          echo "=== PR Reviewæƒ…å ± ==="
          echo "Review Body Length: $(echo '${{ github.event.review.body || '' }}' | wc -c)"
          echo "PR Number: ${{ github.event.pull_request.number || 'N/A' }}"
          echo ""
          echo "=== å®Œå…¨ãªã‚¤ãƒ™ãƒ³ãƒˆãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ ==="
          echo '${{ toJSON(github.event) }}'

      - name: 'GitHub App ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆ'
        id: 'generate_token'
        if: |-
          ${{ vars.APP_ID }}
        uses: 'actions/create-github-app-token@df432ceedc7162793a195dd1713ff69aefc7379e' # ratchet:actions/create-github-app-token@v2
        with:
          app-id: '${{ vars.APP_ID }}'
          private-key: '${{ secrets.APP_PRIVATE_KEY }}'

      - name: 'ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—'
        id: 'get_context'
        uses: 'actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea'
        with:
          github-token: '${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }}'
          script: |-
            console.log('=== ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå–å¾—é–‹å§‹ ===');
            console.log(`Event Name: ${context.eventName}`);
            console.log(`Event Action: ${context.payload.action || 'N/A'}`);
            console.log(`Repository: ${context.repo.owner}/${context.repo.repo}`);
            console.log(`Actor: ${context.actor}`);

            let userRequest = '';
            let issueNumber = '';
            let isPR = false;
            let rawBody = '';
            let issueTitle = '';

            try {
              if (context.eventName === 'issues') {
                rawBody = context.payload.issue.body || '';
              } else if (context.eventName === 'issue_comment') {
                rawBody = context.payload.comment.body || '';
              } else if (context.eventName === 'pull_request_review') {
                rawBody = context.payload.review.body || '';
              } else if (context.eventName === 'pull_request_review_comment') {
                rawBody = context.payload.comment.body || '';
              }

              if (context.eventName === 'issues' || context.eventName === 'issue_comment') {
                issueNumber = context.payload.issue.number.toString();
                issueTitle = context.payload.issue.title || '';
                if (context.payload.issue.pull_request) {
                  isPR = true;
                }
              } else if (context.eventName === 'pull_request_review' || context.eventName === 'pull_request_review_comment') {
                issueNumber = context.payload.pull_request.number.toString();
                issueTitle = context.payload.pull_request.title || '';
                isPR = true;
              }

              userRequest = rawBody;

              // @gemini-jp-cli or @gemini-cli-jp ã‚’æ¢ã—ã¦å‰Šé™¤
              const mentionJpCli = '@gemini-jp-cli';
              const mentionCliJp = '@gemini-cli-jp';
              
              let mentionIndex = userRequest.indexOf(mentionJpCli);
              if (mentionIndex !== -1) {
                userRequest = userRequest.substring(mentionIndex + mentionJpCli.length).trim();
              } else {
                mentionIndex = userRequest.indexOf(mentionCliJp);
                if (mentionIndex !== -1) {
                  userRequest = userRequest.substring(mentionIndex + mentionCliJp.length).trim();
                }
              }
              
              core.setOutput('user_request', userRequest);
              core.setOutput('issue_number', issueNumber);
              core.setOutput('issue_title', issueTitle);
              core.setOutput('is_pr', isPR.toString());
              core.setOutput('raw_body', rawBody);

            } catch (error) {
              core.setFailed(`ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ: ${error.message}`);
              core.setOutput('user_request', 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
              core.setOutput('issue_number', '0');
              core.setOutput('issue_title', 'ã‚¨ãƒ©ãƒ¼');
              core.setOutput('is_pr', 'false');
              core.setOutput('raw_body', '');
            }

      - name: 'ğŸ› ãƒ‡ãƒãƒƒã‚°: å–å¾—ã—ãŸã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ç¢ºèª'
        env:
          USER_REQUEST: ${{ steps.get_context.outputs.user_request }}
          ISSUE_NUMBER: ${{ steps.get_context.outputs.issue_number }}
          ISSUE_TITLE: ${{ steps.get_context.outputs.issue_title }}
          IS_PR: ${{ steps.get_context.outputs.is_pr }}
          RAW_BODY: ${{ steps.get_context.outputs.raw_body }}
        run: |
          echo "=== å–å¾—ã•ã‚ŒãŸã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ ==="
          echo "User Request: '$USER_REQUEST'"
          echo "Issue Number: '$ISSUE_NUMBER'"
          echo "Issue Title: '$ISSUE_TITLE'"
          echo "Is PR: '$IS_PR'"
          echo "Raw Body: '$RAW_BODY'"

      - name: 'ã‚³ãƒŸãƒƒãƒˆç”¨ã®gitãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¨­å®š'
        run: |-
          git config --global user.name 'gemini-cli-jp[bot]'
          git config --global user.email 'gemini-cli-jp[bot]@users.noreply.github.com'

      - name: 'PRãƒ–ãƒ©ãƒ³ãƒã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ'
        if: |-
          ${{  steps.get_context.outputs.is_pr == 'true' }}
        uses: 'actions/checkout@v4'
        with:
          token: '${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }}'
          repository: '${{ github.repository }}'
          ref: 'refs/pull/${{ steps.get_context.outputs.issue_number }}/head'
          fetch-depth: 0

      - name: 'ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ'
        if: |-
          ${{  steps.get_context.outputs.is_pr == 'false' }}
        uses: 'actions/checkout@v4'
        with:
          token: '${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }}'
          repository: '${{ github.repository }}'
          fetch-depth: 0

      - name: 'ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç¢ºèª'
        env:
          GITHUB_ACTOR: '${{ github.actor }}'
          GITHUB_TOKEN: '${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }}'
          ISSUE_NUMBER: '${{ steps.get_context.outputs.issue_number }}'
          REPOSITORY: '${{ github.repository }}'
          USER_REQUEST: '${{ steps.get_context.outputs.user_request }}'
          RAW_BODY: '${{ steps.get_context.outputs.raw_body }}'
        run: |-
          set -euo pipefail
          MESSAGE="@${GITHUB_ACTOR} ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘å–ã‚Šã¾ã—ãŸã€‚ä»Šã‹ã‚‰ä½œæ¥­ã‚’é–‹å§‹ã—ã¾ã™ï¼ ğŸ¤–

          ãƒ‡ãƒãƒƒã‚°æƒ…å ±:
          - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆ: '${USER_REQUEST}'
          - Issue/PRç•ªå·: ${ISSUE_NUMBER}
          - ã‚¤ãƒ™ãƒ³ãƒˆç¨®é¡: ${{ github.event_name }}
          - ç”Ÿãƒ‡ãƒ¼ã‚¿: '${RAW_BODY}'"
          
          if [[ -n "${MESSAGE}" ]]; then
            if [[ "${{ steps.get_context.outputs.is_pr }}" == "true" ]]; then
              gh pr comment "${ISSUE_NUMBER}" \
                --body "${MESSAGE}" \
                --repo "${REPOSITORY}"
            else
              gh issue comment "${ISSUE_NUMBER}" \
                --body "${MESSAGE}" \
                --repo "${REPOSITORY}"
            fi
          fi

      - name: 'èª¬æ˜ã‚’å–å¾—'
        id: 'get_description'
        uses: 'actions/github-script@v7'
        with:
          github-token: '${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }}'
          script: |-
            const isPR = '${{ steps.get_context.outputs.is_pr }}' === 'true';
            const issueNumber = parseInt('${{ steps.get_context.outputs.issue_number }}');
            let description = '';
            try {
              if (isPR) {
                const { data: pr } = await github.rest.pulls.get({
                  owner: context.repo.owner, repo: context.repo.repo, pull_number: issueNumber
                });
                description = pr.body || '';
              } else {
                const { data: issue } = await github.rest.issues.get({
                  owner: context.repo.owner, repo: context.repo.repo, issue_number: issueNumber
                });
                description = issue.body || '';
              }
            } catch (error) {
              description = `${isPR ? 'PR' : 'Issue'}æƒ…å ±ã®å–å¾—ã«å¤±æ•—: ${error.message}`;
            }
            core.setOutput('description', description);

      - name: 'ã‚³ãƒ¡ãƒ³ãƒˆã‚’å–å¾—'
        id: 'get_comments'
        uses: 'actions/github-script@v7'
        with:
          github-token: '${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }}'
          script: |-
            const issueNumber = parseInt('${{ steps.get_context.outputs.issue_number }}');
            let comments = '';
            try {
              const { data: commentsList } = await github.rest.issues.listComments({
                owner: context.repo.owner, repo: context.repo.repo, issue_number: issueNumber
              });
              comments = commentsList.map(comment => `${comment.user.login}: ${comment.body}`).join('\n');
            } catch (error) {
              comments = `ã‚³ãƒ¡ãƒ³ãƒˆã®å–å¾—ã«å¤±æ•—: ${error.message}`;
            }
            core.setOutput('comments', comments);

      - name: 'ğŸ› ãƒ‡ãƒãƒƒã‚°: æœ€çµ‚ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª'
        env:
          USER_REQUEST: ${{ steps.get_context.outputs.user_request }}
          ISSUE_NUMBER: ${{ steps.get_context.outputs.issue_number }}
          ISSUE_TITLE: ${{ steps.get_context.outputs.issue_title }}
          DESCRIPTION: ${{ steps.get_description.outputs.description }}
          COMMENTS: ${{ steps.get_comments.outputs.comments }}
          IS_PR: ${{ steps.get_context.outputs.is_pr }}
        run: |
          echo "=== æœ€çµ‚ãƒ‡ãƒ¼ã‚¿ç¢ºèª ==="
          echo "User Request: '$USER_REQUEST'"
          echo "Issue Number: '$ISSUE_NUMBER'"
          echo "Issue Title: '$ISSUE_TITLE'"
          echo "Description Length: $(echo "$DESCRIPTION" | wc -c)"
          echo "Comments Length: $(echo "$COMMENTS" | wc -c)"
          echo "Is PR: '$IS_PR'"

      - name: 'Geminiã‚’å®Ÿè¡Œ'
        id: 'run_gemini'
        uses: 'google-github-actions/run-gemini-cli@v0'
        env:
          GITHUB_TOKEN: '${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }}'
          REPOSITORY: '${{ github.repository }}'
          USER_REQUEST: '${{ steps.get_context.outputs.user_request }}'
          ISSUE_NUMBER: '${{ steps.get_context.outputs.issue_number }}'
          IS_PR: '${{ steps.get_context.outputs.is_pr }}'
        with:
          gemini_api_key: '${{ secrets.GEMINI_API_KEY }}'
          gcp_workload_identity_provider: '${{ vars.GCP_WIF_PROVIDER }}'
          gcp_project_id: '${{ vars.GOOGLE_CLOUD_PROJECT }}'
          gcp_location: '${{ vars.GOOGLE_CLOUD_LOCATION }}'
          gcp_service_account: '${{ vars.SERVICE_ACCOUNT_EMAIL }}'
          use_vertex_ai: '${{ vars.GOOGLE_GENAI_USE_VERTEXAI }}'
          use_gemini_code_assist: '${{ vars.GOOGLE_GENAI_USE_GCA }}'
          settings: |-
            {
              "debug": true,
              "maxSessionTurns": 50,
              "telemetry": { "enabled": false }
            }
          prompt: |-
            ## ãƒ‡ãƒãƒƒã‚°æƒ…å ±
            - **ç”Ÿã®Body**: `${{ steps.get_context.outputs.raw_body }}`
            - **å‡¦ç†ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**: `${{ steps.get_context.outputs.user_request }}`
            ## å½¹å‰²
            ã‚ãªãŸã¯GitHubãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®CLIã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹çµŒç”±ã§å‘¼ã³å‡ºã•ã‚Œã‚‹è¦ªåˆ‡ãªAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ãƒªãƒã‚¸ãƒˆãƒªã¨ã‚„ã‚Šå–ã‚Šã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¿œç­”ã™ã‚‹ãŸã‚ã®ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚
            ## ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
            - **ãƒªãƒã‚¸ãƒˆãƒª**: `${{ github.repository }}`
            - **ãƒˆãƒªã‚¬ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ**: `${{ github.event_name }}`
            - **Issue/PRç•ªå·**: `${{ steps.get_context.outputs.issue_number }}`
            - **Issue/PRã‚¿ã‚¤ãƒˆãƒ«**: `${{ steps.get_context.outputs.issue_title }}`
            - **ã“ã‚Œã¯PRã§ã™ã‹ï¼Ÿ**: `${{ steps.get_context.outputs.is_pr }}`
            - **Issue/PRã®èª¬æ˜**:
            `${{ steps.get_description.outputs.description }}`
            - **ã‚³ãƒ¡ãƒ³ãƒˆ**:
            `${{ steps.get_comments.outputs.comments }}`
            ## ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
            ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ä»¥ä¸‹ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé€ä¿¡ã•ã‚Œã¾ã—ãŸï¼š
            `${{ steps.get_context.outputs.user_request }}`
            ## æŒ‡ç¤º
            ã‚ãªãŸã¯ç†Ÿç·´ã—ãŸã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¨ã—ã¦æŒ¯ã‚‹èˆã„ã€æä¾›ã•ã‚ŒãŸãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è§£æ±ºã—ã¦ãã ã•ã„ã€‚
            - **è¨ˆç”»ã®æç¤º**: æœ€åˆã«ã€å•é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆå½¢å¼ã§ã‚³ãƒ¡ãƒ³ãƒˆã—ã¦ãã ã•ã„ã€‚(`gh issue comment` ã¾ãŸã¯ `gh pr comment` ã‚’ä½¿ç”¨)
            - **ãƒ–ãƒ©ãƒ³ãƒç®¡ç†**: `main`ãƒ–ãƒ©ãƒ³ãƒã«ã¯ç›´æ¥ã‚³ãƒŸãƒƒãƒˆã—ãªã„ã§ãã ã•ã„ã€‚Issueã®å ´åˆã¯ `issue/${{ steps.get_context.outputs.issue_number }}/<çŸ­ã„èª¬æ˜>` ã®ã‚ˆã†ãªæ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚PRã®å ´åˆã¯ã€ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆæ¸ˆã¿ã®ãƒ–ãƒ©ãƒ³ãƒã§ä½œæ¥­ã—ã¦ãã ã•ã„ã€‚
            - **ã‚³ãƒ¼ãƒ‰ã®å¤‰æ›´**: `write_file` ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦ã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£ã—ã¾ã™ã€‚
            - **ã‚³ãƒŸãƒƒãƒˆã¨ãƒ—ãƒƒã‚·ãƒ¥**: å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆã—ã€é©åˆ‡ãªãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥ã—ã¦ãã ã•ã„ã€‚
            - **å¿œç­”**: å®Œäº†ã—ãŸã‚‰ã€è¡Œã£ãŸå¤‰æ›´ã®æ¦‚è¦ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã§å ±å‘Šã—ã¦ãã ã•ã„ã€‚
            - **è¨€èª**: ã™ã¹ã¦ã®å¿œç­”ã¯æ—¥æœ¬èªã§è¡Œã£ã¦ãã ã•ã„ã€‚
